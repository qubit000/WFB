<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control Center</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/antd/4.24.15/antd.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@reactflow/core@11.10.1/dist/style.css">
    <style>
        /* Custom styles for sidebar and header */
        .layout {
            min-height: 100vh;
        }
        .sider {
            background-color: #001529;
            color: white;
            width: 200px !important;
            max-width: 200px !important;
            min-width: 200px !important;
            flex: 0 0 200px !important;
            padding: 20px 0;
        }
        .sider-link {
            padding: 10px 24px;
            display: block;
            color: rgba(255, 255, 255, 0.65);
            transition: color 0.3s;
            font-size: 16px;
        }
        .sider-link:hover {
            color: #1890ff;
        }
        .sider-break {
            height: 1px;
            background: rgba(255, 255, 255, 0.1);
            margin: 10px 0;
        }
        .header {
            background: white;
            padding: 0 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.05);
            height: 64px;
            line-height: 64px;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .header-title {
            font-size: 18px;
            font-weight: 600;
            color: rgba(0, 0, 0, 0.85);
        }
        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        /* Additional styles for other components */
        .search-input {
            width: 0;
            overflow: hidden;
            transition: width 0.3s;
            margin-left: 8px;
        }
        .search-input.expanded {
            width: 220px;
        }
        .search-wrapper {
            display: flex;
            align-items: center;
        }
        /* A-Z overlay styles */
        .az-overlay {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }
        .workflow-table-header {
            position: sticky;
            top: 0;
            z-index: 10;
            background: white;
        }
        .custom-scrollbar {
            scrollbar-width: thin;
            scrollbar-color: rgba(0, 0, 0, 0.2) transparent;
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: 3px;
        }
        /* Table styles */
        .workflow-table .ant-table-thead > tr > th {
            background: white;
            font-weight: 500;
            padding: 8px 16px;
        }
        .table-header-row {
            background-color: #fafafa;
            font-weight: 500;
        }
        .favorites-row td {
            background-color: #e6f7ff;
        }
        /* Action item styles */
        .operations-item {
            padding: 8px 12px;
            border-radius: 4px;
            transition: all 0.3s;
        }
        .operations-item:hover, .operations-item.hovered {
            background-color: #e6f7ff;
        }
        .operations-item.selected {
            background-color: #1890ff;
            color: white;
        }
        .action-item {
            padding: 8px 12px;
            border-radius: 4px;
            transition: all 0.3s;
        }
        .action-item:hover, .action-item.hovered {
            background-color: #e6f7ff;
        }
        .action-item.selected {
            background-color: #1890ff;
            color: white;
        }
        /* Status cards */
        .status-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 24px;
            text-align: center;
        }
        .status-title {
            margin-top: 16px;
            font-size: 16px;
            font-weight: 500;
        }
        /* Main content padding */
        .content {
            padding: 24px;
        }
        .status-groups {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
        }
        .dropdown-button {
            min-width: 120px;
        }
        .status-dials {
            margin-bottom: 24px;
        }
        .chart-placeholder {
            height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f5f5f5;
            color: rgba(0, 0, 0, 0.45);
            border-radius: 4px;
        }
        /* Edit icons */
        .edit-icon {
            opacity: 0;
            transition: opacity 0.3s;
        }
        .operations-item:hover .edit-icon,
        .action-item:hover .edit-icon,
        .instructions-item:hover .edit-icon {
            opacity: 1;
        }
        /* Star icon */
        .star-icon {
            color: rgba(0, 0, 0, 0.25);
            transition: color 0.3s;
        }
        .star-icon:hover {
            color: #1890ff;
        }
        .star-icon.favorited {
            color: #1890ff;
        }
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .sider {
                width: 80px !important;
                max-width: 80px !important;
                min-width: 80px !important;
                flex: 0 0 80px !important;
            }
            .sider-link {
                padding: 10px;
                text-align: center;
                font-size: 12px;
            }
            .header {
                padding: 0 12px;
            }
            .search-input.expanded {
                width: 160px;
            }
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <!-- Load React and ReactDOM first -->
    <script src="https://unpkg.com/react@17/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js" crossorigin></script>
    
    <!-- Load Ant Design (Core & Icons) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/antd/4.24.15/antd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ant-design-icons/4.7.0/index.umd.min.js"></script>

    <!-- Load other dependencies (React Flow needs React, SortableJS is standalone) -->
    <script src="https://cdn.jsdelivr.net/npm/@reactflow/core@11.10.1/dist/umd/index.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@reactflow/background@11.3.6/dist/umd/index.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@reactflow/controls@11.2.11/dist/umd/index.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    
    <!-- Set reactFlowLoaded flag after scripts are loaded -->
    <script>window.reactFlowLoaded = true;</script>
    
    <!-- Load Babel Standalone (Needs to run before the inline script) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Load your application script (Runs last, uses all libraries) -->
    <script type="text/babel">
        // Ensure React and ReactDOM are properly imported
        const { useState, useEffect, useRef, useCallback, memo, forwardRef } = React;
        const ReactDOM = window.ReactDOM;

        // Destructure from window.antd instead
        const { 
            Layout, 
            Card, 
            Tag, 
            Progress, 
            Row, 
            Col, 
            Segmented, 
            Button, 
            Dropdown, 
            Menu, 
            Badge, 
            Tooltip, 
            Input, 
            Tabs, 
            Steps, 
            Select, 
            Drawer, 
            Form, 
            Checkbox, 
            Radio, 
            Table, 
            Upload, 
            Typography,
            message,
            Popover,
            Divider
        } = window.antd;

        // Destructure from window.icons instead
        const { 
            DownOutlined,
            BellOutlined, 
            SafetyCertificateFilled,
            HolderOutlined,
            UnorderedListOutlined,
            CameraFilled,
            PictureFilled,
            ToolFilled,
            ToolOutlined,
            CheckSquareFilled,
            ReloadOutlined,
            PlusCircleFilled,
            FilterFilled,
            EditFilled,
            CheckOutlined,
            DragOutlined,
            PlusOutlined,
            PlusCircleOutlined,
            TagOutlined,
            FormOutlined,
            CheckSquareOutlined,
            CheckCircleOutlined,
            BarcodeOutlined,
            ExperimentFilled,
            CompressOutlined,
            CheckCircleFilled,
            TagFilled,
            SearchOutlined,
            InboxOutlined,
            CloseOutlined,
            StarFilled,
            StarOutlined,
            BranchesOutlined,
            BarsOutlined,
            AppstoreOutlined,
            SwitcherOutlined,
            NodeIndexOutlined
        } = window.icons;

        const { Title } = Typography;

        const PRIMARY_COLOR = '#1890ff';

        // Define shared constants outside components
        const tagCategories = {
            Door: ['Emergency', 'Exit', 'Steel', 'Fire-Rated', 'Security', 'Double'],
            Panel: ['Control', 'Electric', 'Access', 'Distribution', 'Solar', 'Main'],
            Valve: ['Control', 'Isolation', 'Safety', 'Relief', 'Check', 'Gate'],
            Fan: ['Exhaust', 'Cooling', 'HVAC', 'Industrial', 'Ventilation', 'High-Speed'],
            Unit: ['Air-Handling', 'Processing', 'Control', 'Main', 'Secondary', 'Backup'],
            Cable: ['Power', 'Control', 'Data', 'Fiber', 'Network', 'Signal'],
            Equipment: ['Heavy', 'Industrial', 'Processing', 'Safety', 'Control', 'Monitoring']
        };

        // Add this before the WFBOption1 component definition
        const AddColumnHeader = React.memo(React.forwardRef(({ visibleColumns, setVisibleColumns }, ref) => {
            const mountedRef = React.useRef(true);
            const [localColumns, setLocalColumns] = React.useState(visibleColumns);
            const [dropdownVisible, setDropdownVisible] = React.useState(false);

            // Initialize and cleanup
            React.useEffect(() => {
                mountedRef.current = true;
                setLocalColumns(visibleColumns);
                
                return () => {
                    mountedRef.current = false;
                    setDropdownVisible(false);  // Ensure dropdown is closed on unmount
                };
            }, [visibleColumns]);

            const handleCheckboxChange = React.useCallback((columnName, checked) => {
                if (mountedRef.current) {
                    setVisibleColumns(prev => ({
                        ...prev,
                        [columnName]: checked
                    }));
                    setLocalColumns(prev => ({
                        ...prev,
                        [columnName]: checked
                    }));
                }
            }, []);

            const handleVisibleChange = (visible) => {
                if (mountedRef.current) {
                    setDropdownVisible(visible);  // Allow both open and close
                }
            };

            return (
                <Tooltip 
                    title="Add Column"
                    mouseLeaveDelay={0}
                    destroyTooltipOnHide={true}
                >
                    <div 
                        style={{ 
                            width: '100%', 
                            height: '100%', 
                            display: 'flex', 
                            alignItems: 'center',
                            justifyContent: 'center',
                            cursor: 'pointer'
                        }}
                    >
                        <Dropdown 
                            overlay={
                                <Menu>
                                    {Object.entries(localColumns)
                                           .filter(([columnName]) => columnName !== 'Tags')
                                           .map(([columnName, checked]) => (
                                                <Menu.Item 
                                                    key={columnName}
                                                    style={{ margin: 0, padding: '8px 12px' }}
                                                >
                                                    <div style={{ display: 'flex', alignItems: 'center' }}>
                                                        <Checkbox
                                                            id={`column-checkbox-${columnName}`}
                                                            name={`column-checkbox-${columnName}`}
                                                            checked={checked}
                                                            onChange={(e) => handleCheckboxChange(columnName, e.target.checked)}
                                                            style={{ marginRight: '8px' }}
                                                        >
                                                            {columnName}
                                                        </Checkbox>
                                                    </div>
                                                </Menu.Item>
                                            ))}
                                </Menu>
                            }
                            trigger={['click']}
                            placement="bottomRight"
                            destroyPopupOnHide={true}
                            getPopupContainer={(trigger) => trigger.parentNode}
                            visible={dropdownVisible}
                            onVisibleChange={handleVisibleChange}
                        >
                            <PlusOutlined 
                                style={{ 
                                    fontSize: '14px',
                                    color: 'rgba(0, 0, 0, 0.35)',
                                }}
                                className="plus-icon"
                            />
                        </Dropdown>
                    </div>
                </Tooltip>
            );
        }));

        // Add this before the ActionItem component definition
        const ActionItem = ({ 
            subStep, 
            index, 
            editMode, 
            handleOperationHover, 
            setLockedOperation, 
            setSelectedOperation, 
            lockedOperation, 
            selectedOperation, 
            handleInspectionEditClick, 
            hoveredStep, 
            hoveredAction, 
            setHoveredAction,
            viewType,
            operationActions  // Add this prop
        }) => {
            const mounted = React.useRef(true);

            React.useEffect(() => {
                return () => {
                    mounted.current = false;
                };
            }, []);

            // Get instructions from passed operationActions prop
            const instructions = operationActions[subStep.text] || [];
            const showInstructions = viewType === 'tile' && (subStep.text === hoveredAction || subStep.text === lockedOperation);

            return (
                <div style={{ display: 'flex', flexDirection: 'column' }}>
                    <div 
                        className={`operations-item action-item ${subStep.text === hoveredAction ? 'hovered' : ''} ${subStep.text === lockedOperation ? 'selected' : ''}`}
                        data-index={index}
                        style={{
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'space-between',
                            cursor: editMode === 'Edit' ? 'move' : 'pointer'
                        }}
                        onMouseEnter={() => {
                            handleOperationHover(subStep.text);
                            setHoveredAction(subStep.text);
                        }}
                        onClick={() => {
                            setLockedOperation(subStep.text);
                            setSelectedOperation(subStep.text);
                        }}
                    >
                        <div style={{ 
                            display: 'flex', 
                            alignItems: 'center', 
                            gap: '8px',
                            color: (subStep.text === hoveredAction || subStep.text === lockedOperation) ? 'white' : 'inherit'
                        }}>
                            {subStep.icon}
                            <span style={{ fontSize: '14px' }}>{subStep.text}</span>
                        </div>
                        {editMode === 'Edit' && subStep.text === 'Installation Area Inspection' && 
                         (subStep.text === selectedOperation || hoveredStep === 0) && (
                            <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                                <EditFilled 
                                    className="edit-icon"
                                    style={{ fontSize: '14px' }}
                                    onClick={(e) => {
                                        e.stopPropagation();
                                        handleInspectionEditClick(e);
                                    }}
                                />
                            </div>
                        )}
                    </div>

                    {/* Inline Instructions */}
                    {showInstructions && instructions.length > 0 && (
                        <div style={{
                            marginTop: '8px',
                            padding: '4px 8px',
                            background: '#f7f7f7',
                            borderRadius: '4px',
                            width: '100%'
                        }}>
                            {instructions.map((instruction, idx) => (
                                <div 
                                    key={idx}
                                    style={{
                                        fontSize: '13px',
                                        color: 'rgba(0, 0, 0, 1)', // Changed from 0.65 to 1 for 100% opacity
                                        marginBottom: idx < instructions.length - 1 ? '4px' : 0,
                                        display: 'flex',
                                        alignItems: 'flex-start',
                                        gap: '8px',
                                        padding: '4px 0'
                                    }}
                                >
                                    <span 
                                        style={{
                                            width: '3px',
                                            height: '3px',
                                            backgroundColor: 'rgba(0, 0, 0, 0.45)',
                                            borderRadius: '50%',
                                            marginTop: '8px',
                                            flexShrink: 0
                                        }}
                                    />
                                    <span>{instruction}</span>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        const WFBOption1 = ({ editMode, showAZOverlay, setShowAZOverlay, searchTerm, setSearchTerm, 
            isInteractingWithOverlay, setIsInteractingWithOverlay, selectedTags, setSelectedTags, 
            viewType, variant }) => {
            // Add ALL state declarations at the top
            const [messageApi, contextHolder] = antd.message.useMessage();
            const [hoveredStep, setHoveredStep] = React.useState(null);
            const [selectedStep, setSelectedStep] = React.useState(null);
            const [selectedOperation, setSelectedOperation] = React.useState(null);
            const [lockedOperation, setLockedOperation] = React.useState(null);
            const [mousePosition, setMousePosition] = React.useState({ x: 0, y: 0 });
            const [isHoveringBetweenColumns, setIsHoveringBetweenColumns] = React.useState(false);
            const [drawers, setDrawers] = React.useState([]);
            const [currentWorkflow, setCurrentWorkflow] = React.useState('Main Workflow');
            const [title, setTitle] = React.useState('Emergency Exit Door');
            const [isEditingTitle, setIsEditingTitle] = React.useState(false);
            const [tempTitle, setTempTitle] = React.useState('');
            const [description, setDescription] = React.useState('');
            const [tempDescription, setTempDescription] = React.useState('');
            const [isEditingDescription, setIsEditingDescription] = React.useState(false);
            const [isStageDrawerVisible, setIsStageDrawerVisible] = React.useState(false);
            const [isInspectionDrawerVisible, setIsInspectionDrawerVisible] = React.useState(false);
            const [isCreateWorkflowDrawerVisible, setIsCreateWorkflowDrawerVisible] = React.useState(false);
            const [hoverTimeout, setHoverTimeout] = React.useState(null);
            const [instructionsHoverTimeout, setInstructionsHoverTimeout] = React.useState(null);
            const [isInValidArea, setIsInValidArea] = React.useState(true);
            const [isInActionsArea, setIsInActionsArea] = React.useState(false);
            const [isInInstructionsArea, setIsInInstructionsArea] = React.useState(false);
            const [hoveredOperation, setHoveredOperation] = React.useState(null);
            const [hoveredAction, setHoveredAction] = React.useState(null);
            const [editingInstructionIndex, setEditingInstructionIndex] = React.useState(null);
            const [isRolesDropdownOpen, setIsRolesDropdownOpen] = React.useState(false);

            // Create base steps array
            const baseSteps = [
                {
                    title: "Prepare Installation Area",
                    subSteps: [
                        { icon: <SafetyCertificateFilled style={{ color: 'rgba(0, 0, 0, 0.45)' }} />, text: "Safety Precautions" },
                        { icon: <UnorderedListOutlined style={{ color: 'rgba(0, 0, 0, 0.45)' }} />, text: "Installation Area Inspection" },
                        { icon: <CameraFilled style={{ color: 'rgba(0, 0, 0, 0.45)' }} />, text: "Take Photos" },
                        { icon: <PictureFilled style={{ color: 'rgba(0, 0, 0, 0.45)' }} />, text: "Review Photos" },
                        { icon: <ToolFilled style={{ color: 'rgba(0, 0, 0, 0.45)' }} />, text: "Prepare Tools/Materials" },
                        { icon: <CheckSquareFilled style={{ color: 'rgba(0, 0, 0, 0.45)' }} />, text: "Final Checklist" }
                    ]
                }
            ];

            // Define variant-specific steps
            const variantSteps = [
                ...baseSteps,
                {
                    title: "Install Door Frame",
                    subSteps: [
                        { icon: <UnorderedListOutlined style={{ color: 'rgba(0, 0, 0, 0.45)' }} />, text: "Measure and Mark" },
                        { icon: <UnorderedListOutlined style={{ color: 'rgba(0, 0, 0, 0.45)' }} />, text: "Frame Preparation Checklist" },
                        { icon: <UnorderedListOutlined style={{ color: 'rgba(0, 0, 0, 0.45)' }} />, text: "Install Frame" },
                        { icon: <UnorderedListOutlined style={{ color: 'rgba(0, 0, 0, 0.45)' }} />, text: "Final Frame Installation Check" }
                    ]
                },
                {
                    title: "Install Door",
                    subSteps: [
                        { icon: <UnorderedListOutlined style={{ color: 'rgba(0, 0, 0, 0.45)' }} />, text: "Prepare Door for Installation" },
                        { icon: <UnorderedListOutlined style={{ color: 'rgba(0, 0, 0, 0.45)' }} />, text: "Door Installation Checklist" },
                        { icon: <CameraFilled style={{ color: 'rgba(0, 0, 0, 0.45)' }} />, text: "Take Photo" },
                        { icon: <PictureFilled style={{ color: 'rgba(0, 0, 0, 0.45)' }} />, text: "Review Photo" }
                    ]
                },
                {
                    title: "Install Door Hardware",
                    subSteps: [
                        { icon: <UnorderedListOutlined style={{ color: 'rgba(0, 0, 0, 0.45)' }} />, text: "Prepare for Hardware Installation" },
                        { icon: <UnorderedListOutlined style={{ color: 'rgba(0, 0, 0, 0.45)' }} />, text: "Hardware Installation Checklist" },
                        { icon: <UnorderedListOutlined style={{ color: 'rgba(0, 0, 0, 0.45)' }} />, text: "Final Hardware Check" }
                    ]
                },
                {
                    title: "Test",
                    subSteps: [
                        { icon: <UnorderedListOutlined style={{ color: 'rgba(0, 0, 0, 0.45)' }} />, text: "Testing Instructions" },
                        { icon: <UnorderedListOutlined style={{ color: 'rgba(0, 0, 0, 0.45)' }} />, text: "Installation Verification Checklist" },
                        { icon: <UnorderedListOutlined style={{ color: 'rgba(0, 0, 0, 0.45)' }} />, text: "Functional Test" }
                    ]
                },
                {
                    title: "Finalize Installation",
                    subSteps: [
                        { icon: <CameraFilled style={{ color: 'rgba(0, 0, 0, 0.45)' }} />, text: "Take Photo" },
                        { icon: <PictureFilled style={{ color: 'rgba(0, 0, 0, 0.45)' }} />, text: "Review Photo" },
                        { icon: <UnorderedListOutlined style={{ color: 'rgba(0, 0, 0, 0.45)' }} />, text: "Record Tag" }
                    ]
                }
            ];

            // Define original steps
            const originalSteps = [
                ...baseSteps,
                {
                    title: "Install Door Frame",
                    subSteps: [
                        { icon: <UnorderedListOutlined style={{ color: 'rgba(0, 0, 0, 0.45)' }} />, text: "Measure and Mark" },
                        { icon: <UnorderedListOutlined style={{ color: 'rgba(0, 0, 0, 0.45)' }} />, text: "Frame Preparation Checklist" },
                        { icon: <UnorderedListOutlined style={{ color: 'rgba(0, 0, 0, 0.45)' }} />, text: "Install Frame" },
                        { icon: <UnorderedListOutlined style={{ color: 'rgba(0, 0, 0, 0.45)' }} />, text: "Final Frame Installation Check" },
                        { icon: <CameraFilled style={{ color: 'rgba(0, 0, 0, 0.45)' }} />, text: "Take Photo" },
                        { icon: <PictureFilled style={{ color: 'rgba(0, 0, 0, 0.45)' }} />, text: "Review Photo" },
                        { icon: <CheckSquareFilled style={{ color: 'rgba(0, 0, 0, 0.45)' }} />, text: "Confirmation" }
                ]
            },
            {
                title: "Install Door",
                subSteps: [
                    { icon: <UnorderedListOutlined style={{ color: 'rgba(0, 0, 0, 0.45)' }} />, text: "Prepare Door for Installation" },
                    { icon: <UnorderedListOutlined style={{ color: 'rgba(0, 0, 0, 0.45)' }} />, text: "Door Installation Checklist" },
                    { icon: <CameraFilled style={{ color: 'rgba(0, 0, 0, 0.45)' }} />, text: "Take Photo" },
                    { icon: <PictureFilled style={{ color: 'rgba(0, 0, 0, 0.45)' }} />, text: "Review Photo" },
                    { icon: <CheckSquareFilled style={{ color: 'rgba(0, 0, 0, 0.45)' }} />, text: "Confirmation" }
                ]
            },
            {
                title: "Install Door Hardware",
                subSteps: [
                    { icon: <UnorderedListOutlined style={{ color: 'rgba(0, 0, 0, 0.45)' }} />, text: "Prepare for Hardware Installation" },
                    { icon: <UnorderedListOutlined style={{ color: 'rgba(0, 0, 0, 0.45)' }} />, text: "Hardware Installation Checklist" },
                    { icon: <UnorderedListOutlined style={{ color: 'rgba(0, 0, 0, 0.45)' }} />, text: "Final Hardware Check" },
                    { icon: <CheckSquareFilled style={{ color: 'rgba(0, 0, 0, 0.45)' }} />, text: "Confirmation" }
                ]
            },
            {
                title: "Test",
                subSteps: [
                    { icon: <UnorderedListOutlined style={{ color: 'rgba(0, 0, 0, 0.45)' }} />, text: "Testing Instructions" },
                    { icon: <UnorderedListOutlined style={{ color: 'rgba(0, 0, 0, 0.45)' }} />, text: "Installation Verification Checklist" },
                    { icon: <UnorderedListOutlined style={{ color: 'rgba(0, 0, 0, 0.45)' }} />, text: "Functional Test" }
                ]
            },
            {
                title: "Finalize Installation",
                subSteps: [
                    { icon: <CameraFilled style={{ color: 'rgba(0, 0, 0, 0.45)' }} />, text: "Take Photo" },
                    { icon: <PictureFilled style={{ color: 'rgba(0, 0, 0, 0.45)' }} />, text: "Review Photo" },
                    { icon: <UnorderedListOutlined style={{ color: 'rgba(0, 0, 0, 0.45)' }} />, text: "Record Tag" },
                    { icon: <CheckSquareFilled style={{ color: 'rgba(0, 0, 0, 0.45)' }} />, text: "Confirmation" }
                ]
            }
            ];

            // Single steps state declaration
            const [steps, setSteps] = React.useState(variant === 'variant' ? variantSteps : originalSteps);
            
            // Add useEffect to handle variant changes
            React.useEffect(() => {
                // Update steps whenever variant changes
                setSteps(variant === 'variant' ? variantSteps : originalSteps);
            }, [variant]); // Only re-run when variant changes

            // Add refs
            const operationsContainerRef = React.useRef(null);
            const actionsContainerRef = React.useRef(null);
            const instructionsContainerRef = React.useRef(null);
            const editContainerRef = React.useRef(null);

            // Add error handler
            const handleDragError = React.useCallback((error) => {
                messageApi.error('Failed to reorder items. Please try again.');
                console.error('Drag error:', error);
            }, [messageApi]);

            // Update the useEffect for mouse move events
            React.useEffect(() => {
                let isComponentMounted = true;

                const handleMouseMove = (e) => {
                    if (isComponentMounted) {
                        setMousePosition({ x: e.clientX, y: e.clientY });
                    }
                };

                window.addEventListener('mousemove', handleMouseMove);
                
                return () => {
                    isComponentMounted = false;
                    window.removeEventListener('mousemove', handleMouseMove);
                    if (hoverTimeout) {
                        clearTimeout(hoverTimeout);
                    }
                    if (instructionsHoverTimeout) {
                        clearTimeout(instructionsHoverTimeout);
                    }
                };
            }, [hoverTimeout, instructionsHoverTimeout]);

            const handleStepHover = (index) => {
                setHoveredStep(index);
                if (index !== selectedStep) {
                    setLockedOperation(null);
                    setSelectedOperation(null);
                }
            };

            const handleOperationHover = (operation) => {
                // Clear any existing timeouts
                if (hoverTimeout) {
                    clearTimeout(hoverTimeout);
                }
                if (instructionsHoverTimeout) {
                    clearTimeout(instructionsHoverTimeout);
                }
                setSelectedOperation(operation);
                setLockedOperation(null);  // Clear locked operation on hover
                setIsHoveringBetweenColumns(false);
            };

            const handleEditClick = (section, level = 0) => {
                const newDrawer = {
                    title: `Edit ${section}`,
                    level,
                    visible: true
                };
                
                setDrawers(prev => [...prev, newDrawer]);
            };

            const handleDrawerClose = (level) => {
                setDrawers(prev => prev.filter(d => d.level !== level));
            };

            const handleTitleEdit = () => {
                setTempTitle(title);
                setIsEditingTitle(true);
            };

            const handleInspectionEditClick = (e) => {
                e.stopPropagation(); // Prevent operation selection
                setIsInspectionDrawerVisible(true);
            };

            const handleTitleSave = () => {
                setTitle(tempTitle);
                setDescription(tempDescription);  // Save description too
                setIsEditingTitle(false);
            };

            const handleDescriptionEdit = () => {
                setTempDescription(description);
                setIsEditingDescription(true);
            };

            const handleDescriptionSave = () => {
                setDescription(tempDescription);
                setIsEditingDescription(false);
            };

            const handleStageEditClick = () => {
                setIsStageDrawerVisible(true);
            };

            // First, add a function to handle menu item clicks
            const handleMenuItemClick = (menuKey, insertIndex) => {
                const currentStep = hoveredStep !== null ? hoveredStep : selectedStep;
                if (currentStep === null) return;

                // Create new action based on menu selection
                let newAction = {
                    text: menuKey.charAt(0).toUpperCase() + menuKey.slice(1).replace(/-/g, ' '),
                    icon: null
                };

                // Set appropriate icon based on menu selection
                switch(menuKey) {
                    case 'take-photo':
                        newAction.icon = <CameraFilled style={{ color: 'rgba(0, 0, 0, 0.45)' }} />;
                        break;
                    case 'review-photo':
                        newAction.icon = <PictureFilled style={{ color: 'rgba(0, 0, 0, 0.45)' }} />;
                        break;
                    case 'record-tag':
                        newAction.icon = <TagFilled style={{ color: 'rgba(0, 0, 0, 0.45)' }} />;
                        break;
                    case 'data-entry':
                        newAction.icon = <FormOutlined style={{ color: 'rgba(0, 0, 0, 0.45)' }} />;
                        break;
                    case 'checklist':
                        newAction.icon = <CheckSquareFilled style={{ color: 'rgba(0, 0, 0, 0.45)' }} />;
                        break;
                    case 'smart-tighten':
                        newAction.icon = <ToolFilled style={{ color: 'rgba(0, 0, 0, 0.45)' }} />;
                        break;
                    case 'tool-selection':
                        newAction.icon = <ToolOutlined style={{ color: 'rgba(0, 0, 0, 0.45)' }} />;
                        break;
                    case 'confirmation':
                        newAction.icon = <CheckCircleFilled style={{ color: 'rgba(0, 0, 0, 0.45)' }} />;
                        break;
                    case 'capture-tag':
                        newAction.icon = <BarcodeOutlined style={{ color: 'rgba(0, 0, 0, 0.45)' }} />;
                        break;
                    case 'pressure-test':
                        newAction.icon = <ExperimentFilled style={{ color: 'rgba(0, 0, 0, 0.45)' }} />;
                        break;
                    case 'tension':
                        newAction.icon = <CompressOutlined style={{ color: 'rgba(0, 0, 0, 0.45)' }} />;
                        break;
                    default:
                        newAction.icon = <CheckSquareFilled style={{ color: 'rgba(0, 0, 0, 0.45)' }} />;
                }

                // Update steps with new action
                const updatedSteps = [...steps];
                const subSteps = [...updatedSteps[currentStep].subSteps];
                
                subSteps.splice(insertIndex, 0, newAction);
                updatedSteps[currentStep].subSteps = subSteps;
                setSteps(updatedSteps);
            };

            // Update the plusCircleMenu to include the click handler
            const plusCircleMenu = (insertIndex) => (
                <Menu style={{ width: '200px', margin: '0 auto' }}>
                    <Menu.Item key="take-photo">
                        <div style={{ 
                            display: 'flex', 
                            alignItems: 'center',
                            padding: '0 8px'
                        }}>
                            <CameraFilled style={{ fontSize: '16px', marginRight: '8px', color: 'rgba(0, 0, 0, 0.45)' }} />
                            Take Photo
                        </div>
                    </Menu.Item>
                    <Menu.Item key="review-photo">
                        <div style={{ display: 'flex', alignItems: 'center', padding: '0 8px' }}>
                            <PictureFilled style={{ fontSize: '16px', marginRight: '8px', color: 'rgba(0, 0, 0, 0.45)' }} />
                            Review Photo
                        </div>
                    </Menu.Item>
                    <Menu.Item key="record-tag">
                        <div style={{ display: 'flex', alignItems: 'center', padding: '0 8px' }}>
                            <TagFilled style={{ fontSize: '16px', marginRight: '8px', color: 'rgba(0, 0, 0, 0.45)' }} />
                            Record Tag
                        </div>
                    </Menu.Item>
                    <Menu.Item key="data-entry">
                        <div style={{ display: 'flex', alignItems: 'center', padding: '0 8px' }}>
                            <FormOutlined style={{ fontSize: '16px', marginRight: '8px', color: 'rgba(0, 0, 0, 0.45)' }} />
                            Data Entry
                        </div>
                    </Menu.Item>
                    <Menu.Item key="checklist">
                        <div style={{ display: 'flex', alignItems: 'center', padding: '0 8px' }}>
                            <CheckSquareOutlined style={{ fontSize: '16px', marginRight: '8px', color: 'rgba(0, 0, 0, 0.45)' }} />
                            Checklist
                        </div>
                    </Menu.Item>
                    <Menu.Item key="smart-tighten">
                        <div style={{ display: 'flex', alignItems: 'center', padding: '0 8px' }}>
                            <ToolOutlined style={{ fontSize: '16px', marginRight: '8px', color: 'rgba(0, 0, 0, 0.45)' }} />
                            Smart Tighten
                        </div>
                    </Menu.Item>
                    <Menu.Item key="tool-selection">
                        <div style={{ display: 'flex', alignItems: 'center', padding: '0 8px' }}>
                            <ToolFilled style={{ fontSize: '16px', marginRight: '8px', color: 'rgba(0, 0, 0, 0.45)' }} />
                            Tool Selection
                        </div>
                    </Menu.Item>
                    <Menu.Item key="confirmation">
                        <div style={{ display: 'flex', alignItems: 'center', padding: '0 8px' }}>
                            <CheckCircleOutlined style={{ fontSize: '16px', marginRight: '8px', color: 'rgba(0, 0, 0, 0.45)' }} />
                            Confirmation
                        </div>
                    </Menu.Item>
                    <Menu.Item key="capture-tag">
                        <div style={{ display: 'flex', alignItems: 'center', padding: '0 8px' }}>
                            <BarcodeOutlined style={{ fontSize: '16px', marginRight: '8px', color: 'rgba(0, 0, 0, 0.45)' }} />
                            Capture Tag
                        </div>
                    </Menu.Item>
                    <Menu.Item key="pressure-test">
                        <div style={{ display: 'flex', alignItems: 'center', padding: '0 8px' }}>
                            <ExperimentFilled style={{ fontSize: '16px', marginRight: '8px', color: 'rgba(0, 0, 0, 0.45)' }} />
                            Pressure Test
                        </div>
                    </Menu.Item>
                    <Menu.Item key="tension">
                        <div style={{ display: 'flex', alignItems: 'center', padding: '0 8px' }}>
                            <CompressOutlined style={{ fontSize: '16px', marginRight: '8px', color: 'rgba(0, 0, 0, 0.45)' }} />
                            Tension
                        </div>
                    </Menu.Item>
                    <Menu.Divider />
                    <Menu.Item key="hold-point">
                        <div style={{ display: 'flex', alignItems: 'center', padding: '0 8px' }}>
                            <Badge 
                                count="H" 
                                style={{ 
                                    backgroundColor: 'rgba(0, 0, 0, 0.45)',
                                    marginRight: '8px',
                                    color: 'white',
                                    fontSize: '10px',
                                    width: '14px',
                                    height: '14px',
                                    lineHeight: '15px',
                                    minWidth: '14px',
                                    fontWeight: 'bold',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center'
                                }} 
                            />
                            HOLD POINT
                        </div>
                    </Menu.Item>
                </Menu>
            );

            // Add this items object before getFilteredItems function
            const items = {
                'A': ['Air Handling Unit', 'Access Panel', 'Anchor Bolt', 'Aluminum Framing'],
                'B': [],
                'C': ['Cable', 'Ceiling Fan', 'Conduit', 'Concrete Foundation', 'Control Panel'],
                'D': ['Damper', 'Duct Work', 'Drainage System', 'Door Frame'],
                'E': ['Electrical Panel', 'Emergency Exit Door', 'Elevator', 'Exhaust Fan'],
                'F': [],
                'G': ['Generator', 'Gypsum Board', 'Grounding System', 'Gas Line'],
                'H': [],
                'I': ['Insulation', 'Interior Wall', 'Industrial Fan', 'Iron Beam'],
                'J': [],
                'K': [],
                'L': ['Lighting Fixture', 'Load Center', 'Lift Station', 'Lock System'],
                'M': ['Motor Control', 'Metal Decking', 'Mechanical Room', 'Mounting Bracket'],
                'N': [],
                'O': ['Overhead Door', 'Outlet Box', 'Oil Separator'],
                'P': ['Pump Station', 'Pipe System', 'Power Panel', 'Pressure Gauge'],
                'Q': [],
                'R': [],
                'S': ['Sprinkler System', 'Steel Beam', 'Switchgear', 'Solar Panel'],
                'T': ['Transformer', 'Temperature Sensor', 'Tank', 'Thermostat'],
                'U': ['Utility Room', 'Underground Conduit'],
                'V': ['Ventilation System', 'Valve', 'VFD Panel', 'Vapor Barrier'],
                'W': ['Water Heater', 'Window Frame', 'Wall Panel', 'Wiring Harness'],
                'X': ['X-Bracing'],
                'Y': [],
                'Z': ['Zone Valve', 'Zinc Coating']
            };

            // Then the getFilteredItems function
            const getFilteredItems = () => {
                const filtered = {};
                Object.entries(items).forEach(([letter, list]) => {
                    const filteredList = list.filter(item => {
                        // First check if the item matches the search term
                        const matchesSearch = !searchTerm || item.toLowerCase().includes(searchTerm.toLowerCase());
                        
                        // Then check if it matches any of the selected tags
                        const matchesTags = selectedTags.length === 0 || selectedTags.some(tag => {
                            // Check if the item name contains the tag text
                            const matchesItemName = item.toLowerCase().includes(tag.toLowerCase());
                            
                            // Check if the item type matches the tag's category
                            const itemType = getItemType(item);
                            const matchesCategory = Object.entries(tagCategories).some(([category, tags]) => {
                                return tags.includes(tag) && itemType === category;
                            });
                            
                            return matchesItemName || matchesCategory;
                        });

                        return matchesSearch && matchesTags;
                    });
                    
                    if (filteredList.length > 0) {
                        filtered[letter] = filteredList;
                    } else {
                        filtered[letter] = [];
                    }
                });
                return filtered;
            };

            // Update the click outside handler useEffect
            React.useEffect(() => {
                let isComponentMounted = true;

                const handleClickOutside = (event) => {
                    if (!isComponentMounted) return;
                    
                    const searchInput = document.querySelector('.search-input');
                    const searchIcon = document.querySelector('.search-icon');
                    const overlay = document.querySelector('.az-overlay');
                    const searchWrapper = document.querySelector('.search-wrapper');
                    const tagPopover = document.querySelector('.ant-popover');
                    const tagButton = document.querySelector('.tag-button');
                    const popoverContent = document.querySelector('.ant-popover-content');
                    const tagsArea = document.querySelector('.tags-area');
                    
                    const isTagInteraction = tagPopover?.contains(event.target) || 
                                            tagButton?.contains(event.target) ||
                                            popoverContent?.contains(event.target) ||
                                            tagsArea?.contains(event.target);

                    const isSearchInteraction = searchIcon?.contains(event.target) ||
                                              event.target.classList.contains('search-input') || 
                                              event.target.classList.contains('ant-input-clear-icon') ||
                                              searchWrapper?.contains(event.target) ||
                                              overlay?.contains(event.target);

                    if (isTagInteraction || isSearchInteraction) {
                        if (isComponentMounted) {
                            setIsInteractingWithOverlay(true);
                        }
                        return;
                    }

                    if (!isTagInteraction && !isSearchInteraction && isComponentMounted) {
                        setIsInteractingWithOverlay(false);
                        setShowAZOverlay(false);
                        if (searchInput) {
                            searchInput.classList.remove('expanded');
                        }
                    }
                };

                document.addEventListener('mousedown', handleClickOutside);
                
                return () => {
                    isComponentMounted = false;
                    document.removeEventListener('mousedown', handleClickOutside);
                };
            }, []);

            React.useEffect(() => {
                return () => {
                    if (hoverTimeout) {
                        clearTimeout(hoverTimeout);
                    }
                    if (instructionsHoverTimeout) {
                        clearTimeout(instructionsHoverTimeout);
                    }
                };
            }, [hoverTimeout, instructionsHoverTimeout]);

            React.useEffect(() => {
                let isComponentMounted = true;
                let sortableInstance = null;
                
                if (editMode === 'Edit' && actionsContainerRef.current) {
                    sortableInstance = new Sortable(actionsContainerRef.current, {
                        animation: 150,
                        filter: '.plus-icon-container',
                        preventOnFilter: true,
                        draggable: '.action-item-wrapper',
                        ghostClass: 'sortable-ghost',
                        onStart: function(evt) {
                            if (!isComponentMounted) return;
                            evt.from.classList.add('dragging');
                        },
                        onEnd: function(evt) {
                            if (!isComponentMounted) return;
                            
                            evt.from.classList.remove('dragging');
                            
                            try {
                                const { oldIndex, newIndex } = evt;
                                const currentStepIndex = hoveredStep !== null ? hoveredStep : selectedStep;
                                
                                if (oldIndex !== newIndex && currentStepIndex !== null && isComponentMounted) {
                                    const newSteps = [...steps];
                                    const currentStep = newSteps[currentStepIndex];
                                    const newSubSteps = [...currentStep.subSteps];
                                    
                                    // Preserve variant-specific structure
                                    const movedItem = newSubSteps[oldIndex];
                                    newSubSteps.splice(oldIndex, 1);
                                    newSubSteps.splice(newIndex, 0, movedItem);
                                    
                                    // Ensure we don't add confirmation step in variant mode
                                    if (variant === 'variant' && movedItem.text === 'Confirmation') {
                                        return;
                                    }
                                    
                                    currentStep.subSteps = newSubSteps;
                                    newSteps[currentStepIndex] = currentStep;
                                    setSteps(newSteps);
                                }
                            } catch (error) {
                                handleDragError(error);
                            }
                        }
                    });
                }
                
                return () => {
                    isComponentMounted = false;
                    if (sortableInstance) {
                        sortableInstance.destroy();
                    }
                };
            }, [editMode, hoveredStep, selectedStep, steps, handleDragError]);

            // Update the handleItemClick function
            const handleItemClick = React.useCallback((record) => {
                if (!record.isHeader && !record.isDivider) {
                    setShowAZOverlay(false);
                    // Clear and collapse search input
                    setSearchTerm('');
                    const searchInput = document.querySelector('.search-input');
                    if (searchInput) {
                        searchInput.classList.remove('expanded');
                    }
                }
            }, [setShowAZOverlay, setSearchTerm]);

            const handleInstructionEdit = (index, newValue) => {
                const updatedActions = { ...operationActions };
                updatedActions['Installation Area Inspection'][index] = newValue;
                setOperationActions(updatedActions);
            };

            // First, create a function to transform our items into table data
            const getTableData = () => {
                const data = [];
                const filteredItems = getFilteredItems();
                
                // Add favorited items section at the top if needed
                if (favoritedItems.size > 0) {
                    // Add all favorited items
                    Object.entries(filteredItems).forEach(([letter, itemList]) => {
                        itemList.forEach((item, index) => {
                            const itemKey = `${letter}-${index}`;
                            if (favoritedItems.has(itemKey)) {
                                data.push({
                                    key: `favorite-${itemKey}`, // Unique key for favorites section
                                    name: item,
                                    isHeader: false,
                                    originalKey: itemKey // Store original key for star sync
                                });
                            }
                        });
                    });
                    
                    // Add divider after favorites
                    data.push({
                        key: 'divider-after-favorites',
                        name: '',
                        isDivider: true
                    });
                }

                // Add regular alphabetical sections with all items
                Object.entries(filteredItems).forEach(([letter, itemList]) => {
                    if (itemList.length > 0) {
                        // Add letter header with proper ID
                        data.push({
                            key: `header-${letter}`,
                            name: letter,
                            isHeader: true,
                            id: `table-${letter}`  // Changed from letter-section-${letter} to table-${letter}
                        });
                        // Add all items (both favorited and non-favorited)
                        itemList.forEach((item, index) => {
                            const itemKey = `${letter}-${index}`;
                            data.push({
                                key: itemKey,
                                name: item,
                                isHeader: false
                            });
                        });
                    }
                });
                return data;
            };

            React.useEffect(() => {
                let isSubscribed = true;

                const handleDropdownVisibility = (visible) => {
                    if (!isSubscribed) return;
                    // Your dropdown visibility logic
                };

                return () => {
                    isSubscribed = false;
                };
            }, []);

            React.useEffect(() => {
                const timeouts = new Set();

                const handleHover = () => {
                    const timeout = setTimeout(() => {
                        // Your timeout logic
                    }, 300);
                    timeouts.add(timeout);
                };

                return () => {
                    timeouts.forEach(clearTimeout);
                    timeouts.clear();
                };
            }, []);

            // First, add a state to track favorited items
            const [favoritedItems, setFavoritedItems] = React.useState(new Set());

            // Add a handler function for star clicks
            const handleStarClick = (record) => {
                const newFavorites = new Set(favoritedItems);
                const itemKey = record.originalKey || record.key;

                if (newFavorites.has(itemKey)) {
                    newFavorites.delete(itemKey);
                } else {
                    newFavorites.add(itemKey);
                    setShowFavorites(true); // Show favorites panel when adding new favorite
                }
                setFavoritedItems(newFavorites);
            };

            // Add these helper functions before getFavoritesData and getMainListData
            const getItemType = (itemName) => {
                if (itemName.includes('Door')) return 'Door';
                if (itemName.includes('Panel')) return 'Panel';
                if (itemName.includes('Valve')) return 'Valve';
                if (itemName.includes('Fan')) return 'Fan';
                if (itemName.includes('Pump')) return 'Pump';
                if (itemName.includes('Cable')) return 'Cable';
                if (itemName.includes('Unit')) return 'Unit';
                if (itemName.includes('Room')) return 'Room';
                if (itemName.includes('System')) return 'System';
                return 'Equipment';  // Default type
            };

            const getItemStatus = () => {
                const statuses = ['Untouched', 'In Progress', 'Complete', 'Failed'];
                const randomIndex = Math.floor(Math.random() * statuses.length);
                return statuses[randomIndex];
            };

            // Then your existing getFavoritesData and getMainListData functions...
            const getFavoritesData = () => {
                const data = [];
                const filteredItems = getFilteredItems();  // Use filtered items
                
                Object.entries(filteredItems).forEach(([letter, itemList]) => {
                    itemList.forEach((item, index) => {
                        const itemKey = `${letter}-${index}`;
                        if (favoritedItems.has(itemKey)) {
                            const statusIndex = index % 4;
                            const status = ['Untouched', 'In Progress', 'Complete', 'Failed'][statusIndex];
                            
                            data.push({
                                key: `favorite-${itemKey}`,
                                name: item,
                                isHeader: false,
                                originalKey: itemKey,
                                type: getItemType(item),
                                status: status,
                                group: 'Group...',
                                created: '2024-01-15',
                                updated: '2024-02-20'
                            });
                        }
                    });
                });
                
                return data;
            };

            // Add this helper function near other helper functions
            const getItemTags = (itemName) => {
                const tagPool = {
                    Door: ['Emergency', 'Exit', 'Steel', 'Fire-Rated', 'Security', 'Double'],
                    Panel: ['Control', 'Electric', 'Access', 'Distribution', 'Solar', 'Main'],
                    Valve: ['Control', 'Isolation', 'Safety', 'Relief', 'Check', 'Gate'],
                    Fan: ['Exhaust', 'Cooling', 'HVAC', 'Industrial', 'Ventilation', 'High-Speed'],
                    Unit: ['Air-Handling', 'Processing', 'Control', 'Main', 'Secondary', 'Backup'],
                    Cable: ['Power', 'Control', 'Data', 'Fiber', 'Network', 'Signal'],
                    Equipment: ['Heavy', 'Industrial', 'Processing', 'Safety', 'Control', 'Monitoring']
                };

                // Get relevant tag pool based on item type
                let relevantTags = tagPool.Equipment;  // default
                Object.keys(tagPool).forEach(key => {
                    if (itemName.includes(key)) {
                        relevantTags = tagPool[key];
                    }
                });

                // Randomly select 3-6 tags
                const numTags = 3 + Math.floor(Math.random() * 4);  // Random number between 3 and 6
                const selectedTags = [];
                const availableTags = [...relevantTags];
                
                for (let i = 0; i < numTags && availableTags.length > 0; i++) {
                    const randomIndex = Math.floor(Math.random() * availableTags.length);
                    selectedTags.push(availableTags.splice(randomIndex, 1)[0]);
                }

                return selectedTags;
            };

            const getMainListData = () => {
                const data = [];
                const filteredItems = getFilteredItems();  // Use filtered items
                
                Object.entries(filteredItems).forEach(([letter, itemList]) => {
                    if (itemList.length > 0) {
                        data.push({
                            key: `header-${letter}`,
                            name: letter,
                            isHeader: true,
                            id: `table-${letter}`
                        });
                        itemList.forEach((item, index) => {
                            const itemKey = `${letter}-${index}`;
                            const statusIndex = index % 4;
                            const status = ['Untouched', 'In Progress', 'Complete', 'Failed'][statusIndex];
                            
                            data.push({
                                key: itemKey,
                                name: item,
                                isHeader: false,
                                type: getItemType(item),
                                status: status,
                                tags: getItemTags(item),
                                group: 'Group...',
                                created: '2024-01-15',
                                updated: '2024-02-20'
                            });
                        });
                    }
                });
                
                return data;
            };

            // First, add a state to track visibility
            const [showFavorites, setShowFavorites] = React.useState(true);

            // Move this before the columns state definition
            const starHeaderColumn = {
                title: (
                    <div 
                        onClick={(e) => {
                            e.stopPropagation();
                            if (favoritedItems.size > 0) {
                                setShowFavorites(!showFavorites);
                            }
                        }}
                        style={{ 
                            cursor: favoritedItems.size > 0 ? 'pointer' : 'default',
                            width: '40px',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            padding: '8px'
                        }}
                    >
                        {favoritedItems.size > 0 ? (
                            showFavorites ? (
                                <StarFilled style={{ 
                                    color: '#1890ff', 
                                    transition: 'color 0.3s',
                                    fontSize: '14px'
                                }} />
                            ) : (
                                <StarOutlined style={{ 
                                    color: 'rgba(0, 0, 0, 0.45)', 
                                    transition: 'color 0.3s',
                                    fontSize: '14px'
                                }} />
                            )
                        ) : (
                            <StarOutlined style={{ 
                                color: 'rgba(0, 0, 0, 0.45)', 
                                transition: 'color 0.3s',
                                fontSize: '14px'
                            }} />
                        )}
                    </div>
                ),
                dataIndex: 'favorite',
                width: 40,
                align: 'center',
                fixed: 'left',
                render: (_, record) => {
                    if (record.isDivider || record.isHeader) {
                        return null;
                    }
                    
                    const itemKey = record.originalKey || record.key;
                    
                    return (
                        <Tooltip 
                            title={favoritedItems.has(itemKey) ? "Remove from Favorites" : "Add to Favorites"}
                            mouseLeaveDelay={0}
                            destroyTooltipOnHide={true}  // Add this to ensure tooltip is destroyed when hidden
                        >
                            <div 
                                style={{ 
                                    width: '40px',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    padding: '8px',
                                    cursor: 'pointer'
                                }} 
                                onClick={(e) => {
                                    e.stopPropagation();
                                    handleStarClick(record);
                                }}
                                onMouseLeave={(e) => {
                                    e.currentTarget.blur();
                                    e.stopPropagation();
                                }}
                            >
                                {favoritedItems.has(itemKey) ? (
                                    <StarFilled className="star-icon favorited" style={{ fontSize: '14px' }} />
                                ) : (
                                    <StarOutlined className="star-icon" style={{ fontSize: '14px' }} />
                                )}
                            </div>
                        </Tooltip>
                    );
                }
            };

            // Add this state near the other state declarations
            const [visibleColumns, setVisibleColumns] = React.useState({
                Type: true,
                Status: true,
                Group: true,
                Created: true,
                Updated: true
            });

            // Then update the columns state to use starHeaderColumn as first column
            const [columns, setColumns] = React.useState([
                starHeaderColumn,  // Already has width: 5
                { 
                    title: (
                        <div 
                            className="name-header"
                            style={{ 
                                display: 'flex', 
                                alignItems: 'center', 
                                gap: '8px',
                                justifyContent: 'space-between',
                                width: '100%'
                            }}
                        >
                            <span>Name</span>
                            <div className="filter-icon-wrapper">
                                <FilterFilled 
                                    style={{ 
                                        fontSize: '10px',
                                        color: 'rgba(0, 0, 0, 0.35)',
                                        cursor: 'pointer'
                                    }}
                                    className="filter-icon"
                                />
                            </div>
                        </div>
                    ), 
                    dataIndex: 'name', 
                    align: 'left',
                    width: 200,
                    sorter: true
                },
                { 
                    title: (
                        <div 
                            className="name-header"  // Reusing the same class for consistent behavior
                            style={{ 
                                display: 'flex', 
                                alignItems: 'center', 
                                gap: '8px',
                                justifyContent: 'space-between',
                                width: '100%'
                            }}
                        >
                            <span>Type</span>
                            <div className="filter-icon-wrapper">
                                <FilterFilled 
                                    style={{ 
                                        fontSize: '10px',
                                        color: 'rgba(0, 0, 0, 0.35)',
                                        cursor: 'pointer'
                                    }}
                                    className="filter-icon"
                                />
                            </div>
                        </div>
                    ), 
                    dataIndex: 'type', 
                    align: 'left',
                    width: 120,
                    sorter: true
                },
                { 
                    title: (
                        <div 
                            className="name-header"  // Reusing the same class for consistent behavior
                            style={{ 
                                display: 'flex', 
                                alignItems: 'center', 
                                gap: '8px',
                                justifyContent: 'space-between',
                                width: '100%'
                            }}
                        >
                            <span>Status</span>
                            <div className="filter-icon-wrapper">
                                <FilterFilled 
                                    style={{ 
                                        fontSize: '10px',
                                        color: 'rgba(0, 0, 0, 0.35)',
                                        cursor: 'pointer'
                                    }}
                                    className="filter-icon"
                                />
                            </div>
                        </div>
                    ), 
                    dataIndex: 'status', 
                    align: 'left',
                    width: 120,
                    sorter: true
                },
                { 
                    title: (
                        <div 
                            className="name-header"  // Reusing the same class for consistent behavior
                            style={{ 
                                display: 'flex', 
                                alignItems: 'center', 
                                gap: '8px',
                                justifyContent: 'space-between',
                                width: '100%'
                            }}
                        >
                            <span>Group</span>
                            <div className="filter-icon-wrapper">
                                <FilterFilled 
                                    style={{ 
                                        fontSize: '10px',
                                        color: 'rgba(0, 0, 0, 0.35)',
                                        cursor: 'pointer'
                                    }}
                                    className="filter-icon"
                                />
                            </div>
                        </div>
                    ), 
                    dataIndex: 'group', 
                    align: 'left',
                    width: 120,
                    sorter: true
                },
                { 
                    title: (
                        <div 
                            className="name-header"  // Reusing the same class for consistent behavior
                            style={{ 
                                display: 'flex', 
                                alignItems: 'center', 
                                gap: '8px',
                                justifyContent: 'space-between',
                                width: '100%'
                            }}
                        >
                            <span>Created</span>
                            <div className="filter-icon-wrapper">
                                <FilterFilled 
                                    style={{ 
                                        fontSize: '10px',
                                        color: 'rgba(0, 0, 0, 0.35)',
                                        cursor: 'pointer'
                                    }}
                                    className="filter-icon"
                                />
                            </div>
                        </div>
                    ), 
                    dataIndex: 'created', 
                    align: 'left',
                    width: 100,
                    sorter: true
                },
                { 
                    title: (
                        <div 
                            className="name-header"
                            style={{ 
                                display: 'flex', 
                                alignItems: 'center', 
                                gap: '8px',
                                justifyContent: 'space-between',
                                width: '100%'
                            }}
                        >
                            <span>Updated</span>
                            <div className="filter-icon-wrapper">
                                <FilterFilled 
                                    style={{ 
                                        fontSize: '10px',
                                        color: 'rgba(0, 0, 0, 0.35)',
                                        cursor: 'pointer'
                                    }}
                                    className="filter-icon"
                                />
                            </div>
                        </div>
                    ),
                    dataIndex: 'updated',
                    key: 'updated',
                    align: 'left',
                    width: 100,
                    sorter: true
                },
                {
                    title: <AddColumnHeader 
                        visibleColumns={visibleColumns} 
                        setVisibleColumns={(newState) => {
                            if (mountedRef.current) {
                                setVisibleColumns(newState);
                            }
                        }}
                    />,
                    dataIndex: 'actions',
                    width: 32,
                    align: 'center'
                }
            ]);

            // Add handle column reorder function
            const handleColumnReorder = (dragIndex, hoverIndex) => {
                const dragColumn = columns[dragIndex];
                const newColumns = [...columns];
                newColumns.splice(dragIndex, 1);
                newColumns.splice(hoverIndex, 0, dragColumn);
                setColumns(newColumns);
            };

            // Add this near the other state declarations in WFBOption1
            const [operationActions, setOperationActions] = React.useState({
                'Installation Area Inspection': [
                    'Is the installation area clear of debris and obstructions?',
                    'Are the wall surfaces clean and dry?',
                    'Is there adequate lighting in the installation area?',
                    'Are electrical outlets and wiring properly protected?'
                ],
                'Safety Precautions': [
                    'Verify all required PPE is available and in good condition',
                    'Check area for potential hazards',
                    'Ensure proper ventilation',
                    'Review safety procedures with team'
                ],
                'Take Photos': [
                    'Take photos of installation area before work begins',
                    'Document any existing damage or issues',
                    'Ensure proper lighting for clear photos',
                    'Include reference measurements in photos'
                ],
                'Review Photos': [
                    'Check photo quality and clarity',
                    'Verify all required angles are captured',
                    'Ensure measurements are visible in photos',
                    'Document any concerns or observations'
                ],
                'Prepare Tools/Materials': [
                    'Gather all required tools',
                    'Check tool condition and calibration',
                    'Organize materials needed',
                    'Verify quantities match requirements'
                ],
                'Final Checklist': [
                    'Review all preparation steps',
                    'Verify team readiness',
                    'Confirm all safety measures',
                    'Document completion status'
                ]
            });

            // First, add this state declaration near the other state declarations in WFBOption1
            const [isComponentMounted, setIsComponentMounted] = React.useState(true);

            // Then add this useEffect near the other useEffect hooks
            React.useEffect(() => {
                return () => {
                    setIsComponentMounted(false);
                };
            }, []);

            // Add these handlers:
            const handleFavoriteClick = React.useCallback((e, itemKey) => {
                e.stopPropagation();
                setFavoritedItems(prev => {
                    const newSet = new Set(prev);
                    if (newSet.has(itemKey)) {
                        newSet.delete(itemKey);
                    } else {
                        newSet.add(itemKey);
                    }
                    return newSet;
                });
            }, []);

            // Add this new function near where plusCircleMenu is defined
            const operationsPlusCircleMenu = (index) => (
                <Menu style={{ width: '200px', margin: '0 auto' }}>
                    <Menu.Item key="add-operation">
                        <div style={{ display: 'flex', alignItems: 'center', padding: '0 8px' }}>
                            <UnorderedListOutlined style={{ fontSize: '16px', marginRight: '8px' }} />
                            New Operation
                        </div>
                    </Menu.Item>
                    <Menu.Item key="add-branch">
                        <div style={{ display: 'flex', alignItems: 'center', padding: '0 8px' }}>
                            <BranchesOutlined 
                                style={{ 
                                    fontSize: '16px',
                                    marginRight: '8px',
                                    color: 'rgba(0, 0, 0, 0.45)',
                                    transform: 'scaleY(-1)'
                                }} 
                            />
                            Branch Operation
                        </div>
                    </Menu.Item>
                    <Menu.Divider />
                    <Menu.Item key="hold-point">
                        <div style={{ display: 'flex', alignItems: 'center', padding: '0 8px' }}>
                            <Badge 
                                count="H" 
                                style={{ 
                                    backgroundColor: 'rgba(0, 0, 0, 0.45)',
                                    marginRight: '8px',
                                    color: 'white',
                                    fontSize: '10px',
                                    width: '14px',
                                    height: '14px',
                                    lineHeight: '15px',
                                    minWidth: '14px',
                                    fontWeight: 'bold',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center'
                                }} 
                            />
                            HOLD POINT
                        </div>
                    </Menu.Item>
                </Menu>
            );

            // Add this state near other state declarations
            const [operationsMenuVisible, setOperationsMenuVisible] = React.useState(null);
            const [actionsMenuVisible, setActionsMenuVisible] = React.useState(null);

            // Add these states near other state declarations
            const [draggedRow, setDraggedRow] = React.useState(null);
            const [tableData, setTableData] = React.useState([
                {
                    key: '1',
                    question: 'Is the installation area clear of debris and obstructions?',
                    type: 'Yes/No',
                    includeInReport: true,
                    additionalOptions: '',
                    unit: ''
                },
                {
                    key: '2',
                    question: 'Are the wall surfaces clean and dry?',
                    type: 'Yes/No',
                    includeInReport: true,
                    additionalOptions: '',
                    unit: ''
                },
                {
                    key: '3',
                    question: 'Is there adequate lighting in the installation area?',
                    type: 'Yes/No',
                    includeInReport: true,
                    additionalOptions: '',
                    unit: ''
                },
                {
                    key: '4',
                    question: 'Are electrical outlets and wiring properly protected?',
                    type: 'Yes/No',
                    includeInReport: true,
                    additionalOptions: '',
                    unit: ''
                }
            ]);

            // Add these handlers
            const handleDragStart = (record) => {
                setDraggedRow(record);
            };

            const handleDragOver = (e, record) => {
                e.preventDefault();
                const row = e.target.closest('tr');
                if (row) {
                    row.style.borderTop = '2px solid #1890ff';
                }
            };

            const handleDragLeave = (e) => {
                e.preventDefault();
                const row = e.target.closest('tr');
                if (row) {
                    row.style.borderTop = 'none';
                }
            };

            const handleDrop = (e, targetRecord) => {
                e.preventDefault();
                const row = e.target.closest('tr');
                if (row) {
                    row.style.borderTop = 'none';
                }
                
                if (draggedRow && targetRecord) {
                    const newData = [...tableData];
                    const dragIndex = newData.findIndex(item => item.key === draggedRow.key);
                    const dropIndex = newData.findIndex(item => item.key === targetRecord.key);
                    
                    const temp = newData[dragIndex];
                    newData[dragIndex] = newData[dropIndex];
                    newData[dropIndex] = temp;
                    
                    setTableData(newData);
                    setDraggedRow(null);
                }
            };

            return (
                <Layout.Content style={{ 
                    padding: 0, 
                    backgroundColor: 'white',
                    position: 'relative',
                    overflow: 'hidden'
                }}>
                    {contextHolder}
                    {showAZOverlay && (
                        <div 
                            className="az-overlay"
                            style={{
                                position: 'absolute',
                                top: 0,
                                left: 0,
                                right: 0,
                                bottom: 0,
                                backgroundColor: 'white',
                                borderLeft: '1px solid #f0f0f0',
                                zIndex: 100,  // Changed to 100
                                display: 'flex',
                                flexDirection: 'column'
                            }}
                            onMouseEnter={() => setIsInteractingWithOverlay(true)}
                            onMouseLeave={() => setIsInteractingWithOverlay(false)}
                        >
                            {/* Fixed header section */}
                            <div style={{
                                padding: '16px 16px 8px 16px',
                                borderBottom: '1px solid #f0f0f0'
                            }}>
                                <div style={{
                                    display: 'grid',
                                    gridTemplateColumns: 'auto repeat(26, 1fr)',
                                    gap: '4px',
                                    marginBottom: '8px',
                                    width: '100%',
                                    paddingRight: '12px'
                                }}>
                                    {/* Plus Icon - Moved before A-Z Letters */}
                                    <div style={{
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'center',
                                        marginRight: '2px',
                                        width: '24px'
                                    }}>
                                        <Tooltip title="Create Workflow" placement="right">
                                            <PlusCircleFilled 
                                                className="plus-icon workflow-builder-plus" 
                                                style={{ 
                                                    fontSize: '20px',
                                                    color: 'rgba(0, 0, 0, 0.25)',  /* Updated to match Ant Design default gray */
                                                    transition: 'color 0.3s',
                                                    cursor: 'pointer',
                                                    opacity: 1,
                                                    display: 'block'
                                                }}
                                                onClick={() => setIsCreateWorkflowDrawerVisible(true)}
                                            />
                                        </Tooltip>
                                    </div>

                                    {/* A-Z Letters */}
                                    {[..."ABCDEFGHIJKLMNOPQRSTUVWXYZ"].map(letter => (
                                        <div
                                            key={letter}
                                            style={{
                                                margin: 0,
                                                cursor: getFilteredItems()[letter].length > 0 ? 'pointer' : 'default',
                                                textAlign: 'center',
                                                padding: '4px 8px',
                                                backgroundColor: getFilteredItems()[letter].length > 0 ? '#e6f7ff' : '#f5f5f5', // Changed to lighter blue
                                                color: getFilteredItems()[letter].length > 0 ? '#1890ff' : 'rgba(0, 0, 0, 0.45)',
                                                borderRadius: '4px',
                                                height: '28px',
                                                display: 'flex',
                                                alignItems: 'center',
                                                justifyContent: 'center',
                                                fontSize: '14px',
                                                fontWeight: getFilteredItems()[letter].length > 0 ? '500' : 'normal',
                                                transition: 'all 0.3s',
                                                userSelect: 'none',
                                                minWidth: '28px'
                                            }}
                                            onMouseEnter={(e) => {
                                                if (getFilteredItems()[letter].length > 0) {
                                                    e.target.style.backgroundColor = '#bae7ff'; // Darker blue on hover
                                                    e.target.style.color = '#0050b3';
                                                }
                                            }}
                                            onMouseLeave={(e) => {
                                                if (getFilteredItems()[letter].length > 0) {
                                                    e.target.style.backgroundColor = '#e6f7ff'; // Back to lighter blue
                                                    e.target.style.color = '#1890ff';
                                                }
                                            }}
                                            onClick={() => {
                                                if (getFilteredItems()[letter].length > 0) {
                                                    const tableContainer = document.querySelector('.custom-scrollbar');
                                                    const targetRow = document.querySelector(`[data-row-key="header-${letter}"]`);
                                                    
                                                    if (tableContainer && targetRow) {
                                                        const headerHeight = document.querySelector('.workflow-table-header')?.offsetHeight || 0;
                                                        const scrollOffset = targetRow.offsetTop - headerHeight - 8;
                                                        
                                                        tableContainer.scrollTo({
                                                            top: scrollOffset,
                                                            behavior: 'smooth'
                                                        });
                                                    }
                                                }
                                            }}
                                        >
                                            {letter}
                                        </div>
                                    ))}
                                </div>
                            </div>
                            
                            {/* Table section */}
                            <div style={{
                                display: 'flex',
                                width: '100%',
                                padding: '0 16px',
                                flexDirection: 'column',
                                height: 'calc(100vh - 150px)',
                                overflow: 'hidden'
                            }}>
                                {/* Fixed header */}
                                <div className="workflow-table-header">
                                    <Table 
                                        columns={[starHeaderColumn, ...columns.slice(1)]}
                                        dataSource={[]}
                                        pagination={false}
                                        size="small"
                                        style={{ width: '100%' }}
                                        className="workflow-table"
                                        showHeader={true}
                                        locale={{ emptyText: ' ' }}
                                        components={{
                                            header: {
                                                cell: (props) => {
                                                    const { index } = props;
                                                    if (index === 0) return <th {...props} />;  // Don't make star column draggable
                                                    return <th {...props} style={{ cursor: 'move' }} />;
                                                }
                                            }
                                        }}
                                        onHeaderRow={(column, index) => ({
                                            onDragStart: (e) => {
                                                if (index === 0) {
                                                    e.preventDefault();
                                                    return;
                                                }
                                            },
                                            onDragOver: (e) => {
                                                e.preventDefault();
                                            },
                                            onDrop: (e) => {
                                                if (index === 0) return;  // Prevent dropping on star column
                                                const dragIndex = e.dataTransfer.getData('dragIndex');
                                                if (dragIndex !== '0') {  // Prevent dragging star column
                                                    handleColumnReorder(parseInt(dragIndex, 10), index);
                                                }
                                            },
                                            draggable: index !== 0  // Make all columns except star draggable
                                        })}
                                    />
                                </div>

                                {/* Favorites section - only show if there are favorites AND showFavorites is true */}
                                {favoritedItems.size > 0 && showFavorites && (
                                    <div 
                                        className="favorites-section"
                                        style={{
                                            borderBottom: '1px solid #f0f0f0',
                                            padding: 0
                                        }}>
                                        <Table 
                                            columns={[starHeaderColumn, ...columns.slice(1)]}
                                            dataSource={getFavoritesData()}
                                            pagination={false}
                                            size="small"
                                            style={{ width: '100%' }}
                                            className="workflow-table"
                                            showHeader={false}
                                            locale={{ emptyText: ' ' }}
                                            components={{
                                                body: {
                                                    cell: props => <td {...props} className="favorites-cell" />
                                                }
                                            }}
                                            rowClassName={() => 'favorites-row'}
                                            onRow={(record) => ({
                                                onClick: () => {
                                                    handleItemClick(record);
                                                },
                                                style: {
                                                    cursor: (!record.isHeader && !record.isDivider) ? 'pointer' : 'default'
                                                }
                                            })}
                                        />
                                    </div>
                                )}

                                {/* Scrollable main list */}
                                <div style={{
                                    flex: 1,
                                    overflowY: 'auto'
                                }}
                                className="custom-scrollbar">
                                    <Table 
                                        columns={[starHeaderColumn, ...columns.slice(1)]}
                                        dataSource={getMainListData()}  // New function to get non-favorites items
                                        pagination={false}
                                        size="small"
                                        style={{ 
                                            width: '100%',
                                            borderBottom: '1px solid #f0f0f0'
                                        }}
                                        className="workflow-table"
                                        showHeader={false}
                                        locale={{ emptyText: ' ' }}
                                        rowClassName={(record) => {
                                            if (record.isHeader) {
                                                return 'table-header-row';  // Add this class
                                            }
                                            return 'table-row';
                                        }}
                                        onRow={(record) => ({
                                            onClick: () => {
                                                handleItemClick(record);
                                            },
                                            style: {
                                                cursor: (!record.isHeader && !record.isDivider) ? 'pointer' : 'default'
                                            }
                                        })}
                                    />
                                </div>
                            </div>
                        </div>
                    )}
                    {/* Main Content Area */}
                    <div style={{ 
                        flex: 1, 
                        display: 'flex', 
                        flexDirection: 'column',
                        marginTop: '0'
                    }}>
                        {/* Title and Tabs */}
                        <div style={{
                            padding: '16px 24px',
                            paddingTop: '24px',
                            display: 'flex',
                            flexDirection: 'column',
                            gap: '16px'
                        }}>
                            <div style={{
                                display: 'flex',
                                flexDirection: 'column',
                                gap: '8px',
                                alignItems: 'flex-start'
                            }}>
                                <div style={{
                                    display: 'flex',
                                    flexDirection: 'column',
                                    gap: '8px'
                                }}>
                                    <span style={{
                                        fontSize: '24px',
                                        fontWeight: 500,
                                        color: 'rgba(0, 0, 0, 0.85)',
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '8px'
                                    }}>
                                        {isEditingTitle ? (
                                            <div 
                                                ref={editContainerRef}
                                                style={{ 
                                                    display: 'flex', 
                                                    flexDirection: 'column',
                                                    gap: '8px',
                                                    width: '100%'
                                                }}
                                            >
                                                <Input
                                                    value={tempTitle}
                                                    onChange={(e) => setTempTitle(e.target.value)}
                                                    onPressEnter={() => {
                                                        setTitle(tempTitle);
                                                        setIsEditingTitle(false);
                                                    }}
                                                    onBlur={(e) => {
                                                        // Delay the check to allow the next element to receive focus
                                                        setTimeout(() => {
                                                            if (!editContainerRef.current?.contains(document.activeElement)) {
                                                                setTitle(tempTitle);
                                                                setIsEditingTitle(false);
                                                            }
                                                        }, 0);
                                                    }}
                                                    suffix={
                                                        <CloseOutlined
                                                            style={{ 
                                                                color: 'rgba(0, 0, 0, 0.45)',
                                                                cursor: 'pointer',
                                                                fontSize: '16px'
                                                            }}
                                                            onClick={() => setTempTitle('')}
                                                        />
                                                    }
                                                    autoFocus
                                                    style={{
                                                        fontSize: '24px',
                                                        fontWeight: 500,
                                                        padding: '0',
                                                        border: 'none',
                                                        boxShadow: 'none',
                                                        borderBottom: '2px solid #1890ff'
                                                    }}
                                                    placeholder="Enter title"
                                                />
                                                <Input.TextArea
                                                    value={description}
                                                    onChange={(e) => setDescription(e.target.value)}
                                                    placeholder="Enter description (optional)"  // Modified placeholder text
                                                    autoSize={{ minRows: 1, maxRows: 3 }}
                                                    style={{
                                                        fontSize: '14px',
                                                        border: 'none',
                                                        boxShadow: 'none',
                                                        borderBottom: '1px solid #f0f0f0',
                                                        padding: '4px 0',
                                                        resize: 'none'
                                                    }}
                                                    onBlur={(e) => {
                                                        setTimeout(() => {
                                                            if (!editContainerRef.current?.contains(document.activeElement)) {
                                                                setTitle(tempTitle);
                                                                setIsEditingTitle(false);
                                                            }
                                                        }, 0);
                                                    }}
                                                    onPressEnter={(e) => {
                                                        e.preventDefault(); // Prevent new line
                                                        setTitle(tempTitle);
                                                        setIsEditingTitle(false);
                                                    }}
                                                />
                                            </div>
                                        ) : (
                                            <>
                                                {title}
                                                {editMode === 'Edit' && (
                                                    <EditFilled 
                                                        className="edit-icon"
                                                        style={{ fontSize: '14px' }}  // Changed from 16px to 14px
                                                        onClick={() => {
                                                            setTempTitle(title);
                                                            setIsEditingTitle(true);
                                                        }}
                                                    />
                                                )}
                                            </>
                                        )}
                                    </span>
                                    {!isEditingTitle && (
                                        <Dropdown 
                                            overlay={
                                                <Menu>
                                                    <Menu.Item key="main">Main Workflow</Menu.Item>
                                                    <Menu.Divider style={{ margin: '4px 0' }} />
                                                    <Menu.Item key="properties">Properties</Menu.Item>
                                                    <Menu.Item key="statuses">Statuses</Menu.Item>
                                                    <Menu.Divider style={{ margin: '4px 0' }} />
                                                    <Menu.Item 
                                                        key="add" 
                                                        className="add-workflow-item"
                                                        onClick={() => setIsCreateWorkflowDrawerVisible(true)}
                                                    >
                                                        <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                                                            <PlusCircleFilled 
                                                                style={{ 
                                                                    fontSize: '14px',
                                                                    color: 'rgba(0, 0, 0, 0.65)',
                                                                    transition: 'color 0.3s'
                                                                }}
                                                                className="plus-icon"
                                                            />
                                                            Create Workflow  {/* Changed from "Add Workflow" to "Create Workflow" */}
                                                        </div>
                                                    </Menu.Item>
                                                </Menu>
                                            }
                                            trigger={['hover']}
                                        >
                                            <a 
                                                onClick={e => e.preventDefault()} 
                                                style={{ 
                                                    color: '#1890ff',  // Changed to Ant Design blue
                                                    fontSize: '14px',
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    gap: '4px'
                                                }}
                                            >
                                                Main Workflow <DownOutlined style={{ fontSize: '12px' }} />
                                            </a>
                                        </Dropdown>
                                    )}
                                    {!isEditingTitle && description && (
                                        <span style={{
                                            fontSize: '14px',
                                            color: 'rgba(0, 0, 0, 0.45)',
                                            marginTop: '-4px'
                                        }}>
                                            {description}
                                        </span>
                                    )}
                                </div>
                            </div>
                            <Tabs
                                defaultActiveKey="workflows"
                                className="secondary-tabs"
                                items={[
                                    {
                                        key: 'workflows',
                                        children: (
                                            <div 
                                                className="horizontal-scroll-container"
                                                style={{ 
                                                    display: 'grid',
                                                    gridTemplateColumns: variant === 'variant' ? 
                                                        'repeat(6, 300px)' : // Changed from 7 to 6 columns since we're removing Operations
                                                        '1fr 1fr 1fr',
                                                    gap: '1px',
                                                    backgroundColor: '#f0f0f0',
                                                    marginTop: 0,
                                                    minHeight: 'calc(100vh - 200px)',
                                                    overflowX: variant === 'variant' ? 'auto' : 'hidden',
                                                    width: '100%',
                                                    position: 'relative', // Add this to maintain container stability
                                                    maxWidth: '100%'
                                                }}
                                            >
                                                {/* Only show Operations Column in original view */}
                                                {variant !== 'variant' && (
                                                    <div 
                                                        style={{ 
                                                            backgroundColor: 'white', 
                                                            minHeight: '100%',
                                                            width: '100%',
                                                            minWidth: '300px',
                                                            borderRight: '1px solid #f0f0f0'
                                                        }}
                                                    >
                                                        <div className="workflow-steps-header">
                                                            <div className="header-title">
                                                                <span>Operations</span>
                                                            </div>
                                                        </div>
                                                        <div style={{ padding: '16px' }}>
                                                            {/* Add a ref to track the operations container */}
                                                            <div 
                                                                ref={operationsContainerRef}
                                                                style={{ 
                                                                    display: 'flex', 
                                                                    flexDirection: 'column', 
                                                                    gap: '16px',
                                                                    marginTop: '24px',
                                                                    paddingTop: '5px',    
                                                                    paddingBottom: '5px',  
                                                                    minHeight: '100%'     
                                                                }}
                                                                onMouseEnter={() => {
                                                                    setIsInValidArea(true);
                                                                }}
                                                                onMouseLeave={(e) => {
                                                                    const rect = e.currentTarget.getBoundingClientRect();
                                                                    const extendedTop = rect.top - 5;     // Changed from 10px to 5px
                                                                    const extendedBottom = rect.bottom + 5; // Changed from 10px to 5px
                                                                    
                                                                    if (e.clientY < extendedTop || e.clientY > extendedBottom) {
                                                                        setIsInValidArea(false);
                                                                    }
                                                                }}
                                                            >
                                                                {steps.map((step, index) => (
                                                                    <React.Fragment key={index}>
                                                                        <div 
                                                                            key={index} 
                                                                            className={`operations-item ${step.title === hoveredOperation ? 'hovered' : ''} ${step.title === lockedOperation ? 'selected' : ''}`}
                                                                            onMouseEnter={() => {
                                                                                handleStepHover(index);
                                                                                setHoveredOperation(step.title);
                                                                                setHoveredAction(null);
                                                                                setIsInValidArea(true);
                                                                            }}
                                                                            onClick={() => {
                                                                                setLockedOperation(step.title);
                                                                                setSelectedOperation(null);
                                                                                setSelectedStep(index);
                                                                            }}
                                                                            style={{
                                                                                display: 'flex',
                                                                                alignItems: 'center',
                                                                                justifyContent: 'space-between',
                                                                                cursor: editMode === 'Edit' ? 'move' : 'pointer'
                                                                            }}
                                                                        >
                                                                            <div style={{ display: 'flex', alignItems: 'center' }}>
                                                                                <Badge 
                                                                                    count={index + 1} 
                                                                                    style={{ 
                                                                                        backgroundColor: step.title === lockedOperation ? 'white' : 'rgba(0, 0, 0, 0.35)',
                                                                                        color: step.title === lockedOperation ? '#1890ff' : 'white',
                                                                                        borderRadius: '50%',
                                                                                        width: '20px',
                                                                                        height: '20px',
                                                                                        lineHeight: '20px',
                                                                                        textAlign: 'center',
                                                                                        padding: 0,
                                                                                        fontSize: '12px',
                                                                                        marginRight: '8px',
                                                                                        boxShadow: 'none'
                                                                                    }} 
                                                                                />
                                                                                <span style={{ fontSize: '14px' }}>{step.title}</span>
                                                                            </div>
                                                                            {editMode === 'Edit' && index === 0 && (  // Ensure this condition is correct
                                                                                <EditFilled 
                                                                                    className="edit-icon"
                                                                                    style={{ fontSize: '14px' }}
                                                                                    onClick={handleStageEditClick}
                                                                                />
                                                                            )}
                                                                        </div>

                                                                        {/* Add plus button between operations when in edit mode */}
                                                                        {editMode === 'Edit' && (
                                                                            <Dropdown 
                                                                                overlay={operationsPlusCircleMenu(index + 1)}
                                                                                trigger={['click']}
                                                                                visible={operationsMenuVisible === index}
                                                                                onVisibleChange={(visible) => {
                                                                                    if (isComponentMounted) { // Add mount check
                                                                                        if (visible) {
                                                                                            setOperationsMenuVisible(index);
                                                                                        } else {
                                                                                            setOperationsMenuVisible(null);
                                                                                        }
                                                                                    }
                                                                                }}
                                                                                className="plus-icon-container"
                                                                            >
                                                                                <Tooltip 
                                                                                    title="Add Operation"
                                                                                    mouseEnterDelay={0.1}
                                                                                    placement="top"
                                                                                    align={{
                                                                                        offset: [0, -8]
                                                                                    }}
                                                                                    overlayStyle={{ padding: '0' }}
                                                                                    overlayInnerStyle={{ padding: '4px 8px' }}
                                                                                >
                                                                                    <div style={{
                                                                                        display: 'flex',
                                                                                        justifyContent: 'center',
                                                                                        cursor: 'pointer',
                                                                                        marginTop: '4px'
                                                                                    }}>
                                                                                        <PlusOutlined className="plus-icon" />
                                                                                    </div>
                                                                                </Tooltip>
                                                                            </Dropdown>
                                                                        )}
                                                                    </React.Fragment>
                                                                ))}
                                                            </div>
                                                        </div>
                                                    </div>
                                                )}

                                                {/* Existing Actions Column */}
                                                <div 
                                                    className={variant === 'original' ? 
                                                        `${(hoveredStep !== null || selectedStep !== null) && isInValidArea ? 'active-column' : 'inactive-column'}` 
                                                    : ''}
                                                    style={{ 
                                                        backgroundColor: 'white', 
                                                        minHeight: '100%',
                                                        width: '100%',
                                                        minWidth: '300px', // Add minimum width to each column
                                                        borderRight: '1px solid #f0f0f0'
                                                    }}
                                                >
                                                    <div className="workflow-steps-header">
                                                        <div className="header-title">
                                                            {variant === 'variant' ? (
                                                                <span style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                                                                    <Badge 
                                                                        count="1" 
                                                                        style={{ 
                                                                            backgroundColor: 'rgba(0, 0, 0, 0.35)',
                                                                            boxShadow: 'none',
                                                                            marginRight: '4px'
                                                                        }} 
                                                                    />
                                                                    Prepare Installation Area
                                                                </span>
                                                            ) : (
                                                                <span>Actions</span>
                                                            )}
                                                        </div>
                                                    </div>
                                                    <div style={{ padding: '16px' }}>
                                                        <div 
                                                            style={{ 
                                                                display: 'flex', 
                                                                flexDirection: 'column', 
                                                                gap: '16px',
                                                                marginTop: '24px',
                                                                paddingTop: '5px',    
                                                                paddingBottom: '5px',  
                                                                minHeight: '100%'     
                                                            }}
                                                            ref={actionsContainerRef}
                                                            className="actions-container"
                                                            onMouseEnter={() => {
                                                                setIsInActionsArea(true);
                                                                if (instructionsHoverTimeout) {
                                                                    clearTimeout(instructionsHoverTimeout);
                                                                }
                                                                setIsHoveringBetweenColumns(true);
                                                            }}
                                                            onMouseLeave={(e) => {
                                                                const rect = e.currentTarget.getBoundingClientRect();
                                                                const extendedTop = rect.top - 5;
                                                                const extendedBottom = rect.bottom + 5;
                                                                
                                                                if (e.clientY < extendedTop || e.clientY > extendedBottom) {
                                                                    setIsInActionsArea(false);
                                                                    if (!lockedOperation) {
                                                                        const timeout = setTimeout(() => {
                                                                            setSelectedOperation(null);
                                                                            setIsHoveringBetweenColumns(false);
                                                                        }, 100);
                                                                        setHoverTimeout(timeout);
                                                                    }
                                                                }
                                                            }}
                                                        >
                                                            {(variant === 'variant' || ((hoveredStep !== null || selectedStep !== null) && isInValidArea)) && 
                                                             steps[0].subSteps.map((subStep, index) => (
                                                                <React.Fragment key={index}>
                                                                    <div className="action-item-wrapper" data-index={index}>
                                                                        <div className="action-content">
                                                                            <ActionItem
                                                                                subStep={subStep}
                                                                                index={index}
                                                                                editMode={editMode}
                                                                                handleOperationHover={handleOperationHover}
                                                                                setLockedOperation={setLockedOperation}
                                                                                setSelectedOperation={setSelectedOperation}
                                                                                lockedOperation={lockedOperation}
                                                                                selectedOperation={selectedOperation}
                                                                                handleInspectionEditClick={handleInspectionEditClick}
                                                                                hoveredStep={hoveredStep}
                                                                                hoveredAction={hoveredAction}
                                                                                setHoveredAction={setHoveredAction}
                                                                                viewType={viewType}
                                                                                operationActions={operationActions}
                                                                            />
                                                                        </div>
                                                                        {editMode === 'Edit' && (
                                                                            <Dropdown 
                                                                                overlay={plusCircleMenu(index + 1)}
                                                                                trigger={['click']}
                                                                                onClick={() => setOperationsMenuVisible(null)}
                                                                                visible={actionsMenuVisible === index}
                                                                                onVisibleChange={(visible) => {
                                                                                    if (isComponentMounted) { // Add mount check
                                                                                        if (visible) {
                                                                                            setActionsMenuVisible(index);
                                                                                        } else {
                                                                                            setActionsMenuVisible(null);
                                                                                        }
                                                                                    }
                                                                                }}
                                                                                className="plus-icon-container"
                                                                            >
                                                                                <Tooltip 
                                                                                    title="Add Action"
                                                                                    mouseEnterDelay={0.1}
                                                                                    placement="top"
                                                                                    align={{
                                                                                        offset: [0, -8]
                                                                                    }}
                                                                                    overlayStyle={{ padding: '0' }}
                                                                                    overlayInnerStyle={{ padding: '4px 8px' }}
                                                                                >
                                                                                    <div style={{
                                                                                        display: 'flex',
                                                                                        justifyContent: 'center',
                                                                                        cursor: 'pointer',
                                                                                        marginTop: '4px'
                                                                                    }}>
                                                                                        <PlusOutlined className="plus-icon" />
                                                                                    </div>
                                                                                </Tooltip>
                                                                            </Dropdown>
                                                                        )}
                                                                    </div>
                                                                </React.Fragment>
                                                            ))}
                                                            
                                                            {/* Add initial plus icon if there are no items */}
                                                            {editMode === 'Edit' && (hoveredStep !== null || selectedStep !== null) && 
                                                             isInValidArea && (
                                                                <Dropdown 
                                                                    overlay={plusCircleMenu(steps[hoveredStep !== null ? hoveredStep : selectedStep].subSteps.length)}  // Changed back to plusCircleMenu
                                                                    trigger={['click']}
                                                                    visible={actionsMenuVisible === 'initial'}
                                                                    onVisibleChange={(visible) => {
                                                                        if (isComponentMounted) { // Add mount check
                                                                            if (visible) {
                                                                                setActionsMenuVisible('initial');
                                                                            } else {
                                                                                setActionsMenuVisible(null);
                                                                            }
                                                                        }
                                                                    }}
                                                                    className={`plus-icon-container ${steps[hoveredStep !== null ? hoveredStep : selectedStep].subSteps.length === 0 ? 'initial-plus-container' : ''}`}
                                                                >
                                                                    <Tooltip 
                                                                        title="Add Action"
                                                                            placement="bottom"
                                                                    >
                                                                        <div style={{
                                                                            display: 'flex',
                                                                            justifyContent: 'center',
                                                                            cursor: 'pointer',
                                                                            marginTop: steps[hoveredStep !== null ? hoveredStep : selectedStep].subSteps.length === 0 ? '8px' : '0'
                                                                        }}>
                                                                            <PlusOutlined className="plus-icon" />
                                                                        </div>
                                                                    </Tooltip>
                                                                </Dropdown>
                                                            )}
                                                        </div>
                                                    </div>
                                                </div>

                                                {/* Existing Instructions Column */}
                                                {variant === 'original' && <div 
                                                    className={variant === 'original' ?
                                                        `${((selectedOperation && !isHoveringBetweenColumns) || lockedOperation || isInInstructionsArea) ? 'active-column' : 'inactive-column'}`
                                                        : ''}
                                                    style={{ 
                                                        backgroundColor: 'white', 
                                                        minHeight: '100%',
                                                        width: '100%',
                                                        minWidth: '300px',
                                                        borderRight: '1px solid #f0f0f0'
                                                    }}
                                                    ref={instructionsContainerRef}
                                                    onMouseEnter={() => {
                                                        setIsInInstructionsArea(true);
                                                        if (instructionsHoverTimeout) {
                                                            clearTimeout(instructionsHoverTimeout);
                                                        }
                                                        setIsHoveringBetweenColumns(true);
                                                    }}
                                                    onMouseLeave={(e) => {
                                                        setIsInInstructionsArea(false);
                                                        const instructionsRect = e.currentTarget.getBoundingClientRect();
                                                        if (e.clientY < instructionsRect.top || e.clientY > instructionsRect.bottom) {
                                                            if (!lockedOperation) {
                                                                setSelectedOperation(null);
                                                                setIsHoveringBetweenColumns(false);
                                                            }
                                                        }
                                                    }}
                                                >
                                                    <div className="workflow-steps-header">
                                                        <div className="header-title">
                                                            <span>Instructions</span>
                                                        </div>
                                                    </div>
                                                    <div style={{ padding: '16px' }}>
                                                        {/* Only show instructions content in original view */}
                                                        {variant === 'original' && selectedOperation && operationActions[selectedOperation] && (
                                                            <div style={{ 
                                                                display: 'flex', 
                                                                flexDirection: 'column', 
                                                                gap: '16px',
                                                                marginTop: '24px'
                                                            }}>
                                                                {operationActions[selectedOperation].map((action, index) => (
                                                                    <div 
                                                                        key={index}
                                                                        className={`instructions-item ${editingInstructionIndex === index ? '' : 'hoverable'}`}
                                                                        style={{
                                                                            padding: '4px 8px',
                                                                            display: 'flex',
                                                                            alignItems: 'flex-start',
                                                                            gap: '12px'
                                                                        }}
                                                                    >
                                                                        <span 
                                                                           className="bullet-point"
                                                                            style={{
                                                                            display: 'inline-block',
                                                                            width: '3px',
                                                                            height: '3px',
                                                                                backgroundColor: 'rgba(0, 0, 0, 0.85)',
                                                                            borderRadius: '50%',
                                                                            marginTop: '8px'
                                                                            }}
                                                                        ></span>
                                                                        <div style={{ 
                                                                            flex: 1, 
                                                                            display: 'flex',
                                                                            alignItems: 'flex-start',
                                                                            justifyContent: 'space-between',
                                                                            gap: '8px'
                                                                        }}>
                                                                            {editMode === 'Edit' && 
                                                                             selectedOperation === 'Installation Area Inspection' && 
                                                                             editingInstructionIndex === index ? (
                                                                                <Input.TextArea
                                                                                    value={action}
                                                                                    onChange={(e) => handleInstructionEdit(index, e.target.value)}
                                                                                    autoSize={{ minRows: 1, maxRows: 4 }}
                                                                                    onPressEnter={(e) => {
                                                                                        e.preventDefault();
                                                                                        setEditingInstructionIndex(null);
                                                                                    }}
                                                                                    style={{
                                                                                        flex: 1,
                                                                                        border: 'none',
                                                                                        padding: '0',
                                                                                        resize: 'none',
                                                                                        backgroundColor: 'transparent',
                                                                                        boxShadow: 'none',
                                                                                        borderBottom: '1px solid #1890ff'
                                                                                    }}
                                                                                    autoFocus
                                                                                />
                                                                            ) : (
                                                                                <span>{action}</span>
                                                                            )}
                                                                            {editMode === 'Edit' && 
                                                                             selectedOperation === 'Installation Area Inspection' && (
                                                                                editingInstructionIndex === index ? (
                                                                                    <CheckOutlined 
                                                                                        className="edit-icon"
                                                                                        style={{ 
                                                                                            fontSize: '14px',
                                                                                            marginTop: '4px',
                                                                                            opacity: 1,
                                                                                            color: '#1890ff'
                                                                                        }}
                                                                                        onClick={(e) => {
                                                                                            e.stopPropagation();
                                                                                            setEditingInstructionIndex(null);
                                                                                        }}
                                                                                    />
                                                                                ) : (
                                                                                <EditFilled 
                                                                                    className="edit-icon"
                                                                                    style={{ 
                                                                                        fontSize: '14px',
                                                                                        marginTop: '4px',
                                                                                        opacity: 0,
                                                                                        transition: 'opacity 0.3s'
                                                                                    }}
                                                                                    onClick={(e) => {
                                                                                        e.stopPropagation();
                                                                                        setEditingInstructionIndex(index);
                                                                                    }}
                                                                                />
                                                                                )
                                                                            )}
                                                                        </div>
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>}

                                                {/* Additional Instructions Columns - only show in variant view */}
                                                {variant === 'variant' && steps.slice(1).map((operation, tableIndex) => (
                                                    <div 
                                                        key={`additional-instructions-${tableIndex}`}
                                                        style={{ 
                                                            backgroundColor: 'white', 
                                                            minHeight: '100%',
                                                            width: '100%',
                                                            minWidth: '300px',
                                                            borderRight: '1px solid #f0f0f0'
                                                        }}
                                                    >
                                                        <div className="workflow-steps-header">
                                                            <div className="header-title">
                                                                <span style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                                                                    <Badge 
                                                                        count={tableIndex + 2} 
                                                                        style={{ 
                                                                            backgroundColor: 'rgba(0, 0, 0, 0.35)',
                                                                            boxShadow: 'none',
                                                                            marginRight: '4px'
                                                                        }} 
                                                                    />
                                                                    {operation.title}
                                                                </span>
                                                            </div>
                                                        </div>
                                                        <div style={{ padding: '16px' }}>
                                                            <div 
                                                                style={{ 
                                                                    display: 'flex', 
                                                                    flexDirection: 'column', 
                                                                    gap: '16px',
                                                                    marginTop: '24px',
                                                                    paddingTop: '5px',    
                                                                    paddingBottom: '5px',  
                                                                    minHeight: '100%'     
                                                                }}
                                                                className="actions-container"
                                                            >
                                                                {operation.subSteps.map((subStep, subIndex) => (
                                                                    <React.Fragment key={subIndex}>
                                                                        <div className="action-item-wrapper" data-index={subIndex}>
                                                                            <div className="action-content">
                                                                                <ActionItem
                                                                                    subStep={subStep}
                                                                                    index={subIndex}
                                                                                    editMode={editMode}
                                                                                    handleOperationHover={handleOperationHover}
                                                                                    setLockedOperation={setLockedOperation}
                                                                                    setSelectedOperation={setSelectedOperation}
                                                                                    lockedOperation={lockedOperation}
                                                                                    selectedOperation={selectedOperation}
                                                                                    handleInspectionEditClick={handleInspectionEditClick}
                                                                                    hoveredStep={hoveredStep}
                                                                                    hoveredAction={hoveredAction}
                                                                                    setHoveredAction={setHoveredAction}
                                                                                    viewType={viewType}
                                                                                    operationActions={operationActions}
                                                                                />
                                                                            </div>
                                                                            {editMode === 'Edit' && (
                                                                                <Dropdown 
                                                                                    overlay={plusCircleMenu(subIndex + 1)}
                                                                                    trigger={['click']}
                                                                                    visible={actionsMenuVisible === `${tableIndex}-${subIndex}`}
                                                                                    onVisibleChange={(visible) => {
                                                                                        if (isComponentMounted) { // Add mount check
                                                                                            if (visible) {
                                                                                                setActionsMenuVisible(`${tableIndex}-${subIndex}`);
                                                                                            } else {
                                                                                                setActionsMenuVisible(null);
                                                                                            }
                                                                                        }
                                                                                    }}
                                                                                    className="plus-icon-container"
                                                                                >
                                                                                    <Tooltip 
                                                                                        title="Add Action"
                                                                                        mouseEnterDelay={0.1}
                                                                                        placement="top"
                                                                                        align={{
                                                                                            offset: [0, -8]
                                                                                        }}
                                                                                        overlayStyle={{ padding: '0' }}
                                                                                        overlayInnerStyle={{ padding: '4px 8px' }}
                                                                                    >
                                                                                        <div style={{
                                                                                            display: 'flex',
                                                                                            justifyContent: 'center',
                                                                                            cursor: 'pointer',
                                                                                            marginTop: '4px'
                                                                                        }}>
                                                                                            <PlusOutlined className="plus-icon" />
                                                                                        </div>
                                                                                    </Tooltip>
                                                                                </Dropdown>
                                                                            )}
                                                                        </div>
                                                                    </React.Fragment>
                                                                ))}
                                                            </div>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        )
                                    }
                                ]}
                            />
                        </div>
                    </div>

                    {drawers.map((drawer, index) => (
                        <Drawer
                            key={drawer.level}
                            title={drawer.title}
                            placement="right"
                            onClose={() => handleDrawerClose(drawer.level)}
                            open={drawer.visible}
                            width={500}
                            mask={index === drawers.length - 1}
                            maskClosable={false}
                            style={{
                                position: 'absolute',
                                right: `${drawer.level * 500}px`,
                                zIndex: 1000 + drawer.level
                            }}
                            extra={
                                <Button 
                                    type="primary" 
                                    onClick={() => handleEditClick(`${drawer.title} Sub-Item`, drawer.level + 1)}
                                >
                                    Add Sub-Item
                                </Button>
                            }
                        >
                            <Form layout="vertical">
                                {/* Form content specific to each level */}
                                <Form.Item label="Name" required>
                                    <Input placeholder="Enter name" />
                                </Form.Item>
                                <Form.Item label="Description">
                                    <Input.TextArea 
                                        rows={1}
                                        autoSize={{ minRows: 1, maxRows: 6 }}
                                        placeholder="Enter workflow description..."
                                        style={{ resize: 'vertical' }}
                                    />
                                </Form.Item>
                            </Form>
                        </Drawer>
                    ))}

                    <Drawer
                        placement="right"
                        width={400}
                        onClose={() => setIsStageDrawerVisible(false)}
                        open={isStageDrawerVisible}
                        closeIcon={null}
                        maskClosable={false}
                        extra={
                            <div style={{ 
                                display: 'flex', 
                                gap: '8px',
                                width: '100%',
                                justifyContent: 'flex-end',
                                alignItems: 'center'  /* Add this to vertically center all items */
                            }}>
                                <div 
                                    onClick={() => {
                                        // Add your delete logic here
                                    }}
                                    style={{ 
                                        color: 'rgba(0, 0, 0, 0.30)',
                                        cursor: 'pointer',
                                        fontSize: '14px',
                                        position: 'absolute',
                                        left: '24px',
                                        transition: 'color 0.3s'
                                    }}
                                    onMouseEnter={(e) => {
                                        e.currentTarget.style.color = '#ff4d4f';
                                    }}
                                    onMouseLeave={(e) => {
                                        e.currentTarget.style.color = 'rgba(0, 0, 0, 0.30)';
                                    }}
                                >
                                    Delete Operation
                                </div>
                                <Button 
                                    onClick={() => setIsStageDrawerVisible(false)}
                                    style={{ borderRadius: '6px' }}
                                >
                                    Cancel
                                </Button>
                                <Button 
                                    type="primary" 
                                    style={{ borderRadius: '6px' }}
                                >
                                    Save
                                </Button>
                            </div>
                        }
                        title=""
                    >
                        <Form layout="vertical">
                            <Form.Item label="Operation Name" required>
                                <Input defaultValue="Prepare Installation Area" />
                            </Form.Item>
                            <Form.Item label="Operation Label" required>
                                <Input defaultValue="Prepare Installation Area" />
                            </Form.Item>
                            <Form.Item label="Warning Message">
                                <Input.TextArea 
                                    placeholder="A warning message will appear when a user starts this operation"
                                    rows={2}
                                />
                            </Form.Item>
                            <Form.Item label="Required Roles" required>
                                <Select
                                    placeholder="Select"
                                    style={{ width: '100%' }}
                                    dropdownRender={(menu) => (
                                        <Checkbox.Group style={{ padding: '8px', display: 'flex', flexDirection: 'column', gap: '8px' }}>
                                            <Checkbox value="fitter">Fitter</Checkbox>
                                            <Checkbox value="qa">QA</Checkbox>
                                            <Checkbox value="qc">QC</Checkbox>
                                        </Checkbox.Group>
                                    )}
                                    defaultOpen={false}
                                    mode="multiple"
                                    maxTagCount={0}
                                    maxTagPlaceholder={() => 'Select'}
                                />
                            </Form.Item>
                            <Form.Item label="Failure Status">
                                <Select defaultValue="PreparationFailed">
                                    <Select.Option value="PreparationFailed">PreparationFailed</Select.Option>
                                </Select>
                            </Form.Item>
                            <Form.Item label="Prerequisite Status" required>
                                <Select defaultValue="Untouched" mode="tags">
                                    <Select.Option value="Untouched">Untouched</Select.Option>
                                </Select>
                            </Form.Item>
                            <Form.Item label="Workflow Conditions">
                                <Radio.Group defaultValue="AND">
                                    <Radio.Button value="AND">AND</Radio.Button>
                                    <Radio.Button value="OR">OR</Radio.Button>
                                </Radio.Group>
                                <Button type="text" icon={<PlusOutlined />} style={{ marginLeft: '8px' }} />
                            </Form.Item>
                            <Form.Item label="Hold Points">
                                <Form.Item label="Hold Point Operation" style={{ marginBottom: 0 }}>
                                    <Select defaultValue="None">
                                        <Select.Option value="None">None</Select.Option>
                                    </Select>
                                </Form.Item>
                            </Form.Item>
                        </Form>
                    </Drawer>

                    <Drawer
                        placement="bottom"
                        height={400}
                        onClose={() => setIsInspectionDrawerVisible(false)}
                        open={isInspectionDrawerVisible}
                        closeIcon={null}
                        maskClosable={false}
                        extra={
                            <div style={{ 
                                display: 'flex', 
                                gap: '8px',
                                width: '100%',
                                justifyContent: 'flex-end'
                            }}>
                                <div 
                                    onClick={() => {
                                        // Add your delete logic here
                                    }}
                                    style={{ 
                                        color: 'rgba(0, 0, 0, 0.30)',
                                        cursor: 'pointer',
                                        fontSize: '14px',
                                        position: 'absolute',
                                        left: '24px',
                                        transition: 'color 0.3s'
                                    }}
                                    onMouseEnter={(e) => {
                                        e.currentTarget.style.color = '#ff4d4f';
                                    }}
                                    onMouseLeave={(e) => {
                                        e.currentTarget.style.color = 'rgba(0, 0, 0, 0.30)';
                                    }}
                                >
                                    Delete Action
                                </div>
                                <Button 
                                    onClick={() => setIsInspectionDrawerVisible(false)}
                                    style={{ borderRadius: '6px' }}
                                >
                                    Cancel
                                </Button>
                                <Button 
                                    type="primary" 
                                    onClick={() => setIsInspectionDrawerVisible(false)}
                                    style={{ borderRadius: '6px' }}
                                >
                                    Save
                                </Button>
                            </div>
                        }
                        title=""
                    >
                        <Form layout="vertical">
                            <Form.Item label="Action" required>
                                <Input defaultValue="Installation Area Inspection" />
                            </Form.Item>
                            <Table
                                columns={[
                                    {
                                        title: '',
                                        key: 'dragHandle',
                                        width: '40px',
                                        render: (_, record) => (
                                            <HolderOutlined 
                                                style={{ 
                                                    color: 'rgba(0, 0, 0, 0.45)',
                                                    fontSize: '16px',
                                                    cursor: 'grab'
                                                }}
                                                draggable="true"
                                                onDragStart={() => handleDragStart(record)}
                                                onMouseDown={(e) => {
                                                    e.currentTarget.style.cursor = 'grabbing';
                                                    e.currentTarget.closest('tr').draggable = true;
                                                }}
                                                onMouseUp={(e) => {
                                                    e.currentTarget.style.cursor = 'grab';
                                                    e.currentTarget.closest('tr').draggable = false;
                                                }}
                                            />
                                        )
                                    },
                                    {
                                        title: 'Instruction',
                                        dataIndex: 'question',
                                        key: 'question',
                                        render: (text, record) => (
                                            <Input.TextArea
                                                defaultValue={text}
                                                autoSize={{ minRows: 1, maxRows: 4 }}
                                                style={{ 
                                                    border: 'none',
                                                    resize: 'none',
                                                    backgroundColor: 'transparent',
                                                    width: '100%',
                                                    padding: '4px 8px'
                                                }}
                                                placeholder="Enter instruction"
                                            />
                                        ),
                                        width: '40%'
                                    },
                                    {
                                        title: 'Type',
                                        dataIndex: 'type',
                                        key: 'type',
                                        render: (text) => (
                                            <Select
                                                defaultValue={text || "Yes/No"}
                                                style={{ width: '100%' }}
                                                bordered={false}
                                            >
                                                <Select.Option value="Yes/No">Yes/No</Select.Option>
                                                <Select.Option value="Text">Text</Select.Option>
                                                <Select.Option value="Number">Number</Select.Option>
                                                <Select.Option value="Checkbox">Checkbox</Select.Option>
                                            </Select>
                                        ),
                                        width: '15%'
                                    },
                                    {
                                        title: 'Include in Report',
                                        dataIndex: 'includeInReport',
                                        key: 'includeInReport',
                                        render: () => (
                                            <Checkbox style={{ marginLeft: '8px' }} />
                                        ),
                                        width: '15%'
                                    },
                                    {
                                        title: 'Additional Options',
                                        dataIndex: 'additionalOptions',
                                        key: 'additionalOptions',
                                        render: (text) => (
                                            <Input.TextArea
                                                defaultValue={text}
                                                autoSize={{ minRows: 1, maxRows: 4 }}
                                                style={{ 
                                                    border: 'none',
                                                    resize: 'none',
                                                    backgroundColor: 'transparent',
                                                    width: '100%',
                                                    padding: '4px 8px'
                                                }}
                                                placeholder="Enter options"
                                            />
                                        ),
                                        width: '20%'
                                    },
                                    {
                                        title: 'Unit',
                                        dataIndex: 'unit',
                                        key: 'unit',
                                        render: (text) => (
                                            <Input
                                                defaultValue={text}
                                                style={{ 
                                                    border: 'none',
                                                    backgroundColor: 'transparent',
                                                    width: '100%',
                                                    padding: '4px 8px'
                                                }}
                                                placeholder="Enter unit"
                                            />
                                        ),
                                        width: '10%'
                                    }
                                ]}
                                dataSource={tableData}
                                onRow={(record) => ({
                                    onDragOver: (e) => handleDragOver(e, record),
                                    onDragLeave: handleDragLeave,
                                    onDrop: (e) => handleDrop(e, record)
                                })}
                                pagination={false}
                                bordered
                                style={{
                                    marginTop: '16px'
                                }}
                            />
                            <div 
                                style={{
                                    display: 'flex',
                                    justifyContent: 'center',
                                    marginTop: '16px'
                                }}
                            >
                                <Tooltip 
                                    title="Add Instruction"
                                    mouseEnterDelay={0.1}
                                    placement="top"
                                >
                                    <PlusCircleFilled 
                                        style={{
                                            fontSize: '24px',
                                            color: 'rgba(0, 0, 0, 0.45)',
                                            cursor: 'pointer',
                                            transition: 'color 0.3s'
                                        }}
                                        onMouseEnter={(e) => {
                                            e.currentTarget.style.color = '#1890ff';
                                        }}
                                        onMouseLeave={(e) => {
                                            e.currentTarget.style.color = 'rgba(0, 0, 0, 0.45)';
                                        }}
                                    />
                                </Tooltip>
                            </div>
                        </Form>
                    </Drawer>

                    <Drawer
                        title={
                            <div style={{ 
                                display: 'flex', 
                                alignItems: 'center', 
                                gap: '8px',
                                paddingLeft: 0
                            }}>
                                <PlusCircleFilled style={{ color: '#1890ff', fontSize: '18px' }} />
                                <span style={{ fontSize: '20px' }}>Create Workflow</span>
                            </div>
                        }
                        placement="top"
                        height="auto"  // Changed from removing height to setting it to "auto"
                        styles={{ 
                            header: { 
                                fontSize: '18px',
                                paddingRight: '24px',
                                padding: '16px 24px',
                                marginLeft: '-20px'
                            },
                            body: {
                                padding: '24px'
                            }
                        }}
                        closeIcon={null}
                        maskClosable={false}
                        onClose={() => setIsCreateWorkflowDrawerVisible(false)}
                        open={isCreateWorkflowDrawerVisible}
                        extra={
                            <div style={{ display: 'flex', gap: '8px' }}>
                                <Button
                                    onClick={() => setIsCreateWorkflowDrawerVisible(false)}
                                    style={{ borderRadius: '6px' }}
                                >
                                    Cancel
                                </Button>
                                <Button 
                                    type="primary"
                                    onClick={() => setIsCreateWorkflowDrawerVisible(false)}
                                    style={{ borderRadius: '6px' }}
                                >
                                    Save
                                </Button>
                            </div>
                        }
                    >
                        <Form layout="vertical">
                            <Form.Item
                                label="Describe the procedure to create a custom workflow"
                                required
                                className="resize-textarea"
                            >
                                <Input.TextArea 
                                    rows={1}
                                    autoSize={{ minRows: 1, maxRows: 6 }}
                                    placeholder="Enter workflow description..."
                                    style={{ 
                                        resize: 'both',
                                        minHeight: '32px',
                                        overflow: 'auto'
                                    }}
                                />
                            </Form.Item>
                            <div style={{ marginTop: '24px' }}>
                                <div style={{ marginBottom: '16px' }}>
                                    or Upload a work procedure document to create a digital workflow.
                                </div>
                                <div style={{ 
                                    color: 'rgba(0, 0, 0, 0.45)', 
                                    fontSize: '12px', 
                                    marginBottom: '8px' 
                                }}>
                                    Supported: .pdf, .tiff, .png, .docx, .html, .csv, .pptx, .rtf, .svg, .xlsx, and .jpeg
                                </div>
                                <div style={{ 
                                    color: 'rgba(0, 0, 0, 0.45)', 
                                    fontSize: '12px', 
                                    marginBottom: '8px' 
                                }}>
                                    Supported: .pdf, .tiff, .png, .docx, .html, .csv, .pptx, .rtf, .svg, .xlsx, and .jpeg
                                </div>
                                <div style={{ 
                                    color: 'rgba(0, 0, 0, 0.45)', 
                                    fontSize: '12px', 
                                    marginBottom: '8px' 
                                }}>
                                    Supported: .pdf, .tiff, .png, .docx, .html, .csv, .pptx, .rtf, .svg, .xlsx, and .jpeg
                                </div>
                                <Upload.Dragger
                                    style={{ 
                                        padding: '24px',
                                        background: '#f5f5f5',
                                        borderRadius: '6px'
                                    }}
                                >
                                    <p className="ant-upload-drag-icon">
                                        <InboxOutlined />
                                    </p>
                                    <p className="ant-upload-text">
                                        Drop a document here or click to select a file
                                    </p>
                                </Upload.Dragger>
                            </div>
                        </Form>
                    </Drawer>
                </Layout.Content>
            );
        };

        // Remove the top-level extraction
        const WFBFlow = ({ editMode, showAZOverlay, setShowAZOverlay, searchTerm, setSearchTerm, 
            isInteractingWithOverlay, setIsInteractingWithOverlay, selectedTags, setSelectedTags }) => {
            const [isLoaded, setIsLoaded] = React.useState(false);
            const [retryCount, setRetryCount] = React.useState(0);
            const maxRetries = 10;
            
            React.useEffect(() => {
                const checkReactFlow = () => {
                    console.log('Checking React Flow availability...');
                    if (window.ReactFlow && window.reactFlowLoaded) {
                        console.log('React Flow is ready!');
                        setIsLoaded(true);
                    } else {
                        console.log('React Flow not ready, retrying...');
                        if (retryCount < maxRetries) {
                            setRetryCount(prev => prev + 1);
                            setTimeout(checkReactFlow, 1000);
                        } else {
                            console.error('Failed to load React Flow after maximum retries');
                        }
                    }
                };
                checkReactFlow();
                return () => {
                    setIsLoaded(false);
                    setRetryCount(0);
                };
            }, [retryCount]);

            if (!isLoaded) {
                console.log('Still loading React Flow...');
                return <div style={{ padding: '24px' }}>Loading React Flow... {retryCount}/{maxRetries}</div>;
            }

            console.log('React Flow loaded, rendering diagram...');
            const { ReactFlow, Background, Controls } = window.ReactFlow;
            
            // Define nodes and edges for React Flow
            const nodes = [
                {
                    id: '1',
                    data: { label: 'Node 1' },
                    position: { x: 250, y: 5 }
                },
                {
                    id: '2',
                    data: { label: 'Node 2' },
                    position: { x: 100, y: 100 }
                },
                {
                    id: '3',
                    data: { label: 'Node 3' },
                    position: { x: 400, y: 100 }
                }
            ];

            const edges = [
                { id: 'e1-2', source: '1', target: '2' },
                { id: 'e1-3', source: '1', target: '3' }
            ];

            return (
                <Layout.Content style={{ 
                    padding: 0, 
                    backgroundColor: 'white',
                    position: 'relative',
                    overflow: 'hidden'
                }}>
                    <div style={{
                        background: 'white',
                        padding: '24px',
                        borderRadius: '8px',
                        minHeight: 'calc(100vh - 64px - 90px - 48px)',
                        display: 'flex',
                        flexDirection: 'column'
                    }}>
                        <div style={{ width: '100%', height: '800px' }}>
                            <div style={{ width: '100%', height: '100%' }}>
                                <ReactFlow 
                                    nodes={nodes} 
                                    edges={edges} 
                                    fitView
                                >
                                    <Background />
                                    <Controls />
                                </ReactFlow>
                            </div>
                        </div>
                    </div>
                </Layout.Content>
            );
        };

        const MainContent = () => {
            const isMounted = React.useRef(true);
            const statusData = [
                { title: 'Unstarted', count: 427, color: '#1890ff' },
                { title: 'In Progress', count: 84, color: '#13c2c2' },
                { title: 'Completed', count: 0, color: '#d9d9d9' },
                { title: 'Failed', count: 19, color: '#ff4d4f' },
            ];

            const [currentStatusGroup, setCurrentStatusGroup] = React.useState('default');
            
            // Cleanup on unmount
            React.useEffect(() => {
                return () => {
                    isMounted.current = false;
                };
            }, []);

            // Wrap state updates in mounted check
            const safeSetState = (callback) => {
                if (isMounted.current) {
                    callback();
                }
            };

            const menuItems = ['Status 1', 'Status 2', 'Status 3']; // Add menu items

            const statusMenu = (
                <Menu style={{ 
                    padding: 0,
                    width: '900px',
                    maxHeight: '400px',
                    overflow: 'hidden',
                    display: 'flex',
                    flexDirection: 'column'
                }}>
                    <div style={{ 
                        display: 'flex',
                        flexDirection: 'column',
                        marginBottom: '12px',
                        width: '100%',
                        backgroundColor: 'white',
                        position: 'sticky',
                        top: 0,
                        zIndex: 1,
                        padding: '12px 12px 0 12px'
                    }}>
                        {/* A-Z Letters grid */}
                        <div style={{ 
                            display: 'grid',
                            gridTemplateColumns: 'repeat(26, minmax(0, 1fr))',
                            gap: '8px',
                            width: '100%',
                            paddingRight: '12px',
                            marginBottom: '12px'
                        }}>
                            {[..."ABCDEFGHIJKLMNOPQRSTUVWXYZ"].map(letter => {
                                const isActive = ['C', 'E', 'F', 'M', 'S', 'V'].includes(letter);
                                
                                return (
                                    <Menu.Item 
                                        key={letter}
                                        disabled={!isActive}
                                        style={{
                                            margin: 0,
                                            cursor: isActive ? 'pointer' : 'default',
                                            textAlign: 'center',
                                            padding: '4px',
                                            backgroundColor: isActive ? '#e6f7ff' : '#f5f5f5',
                                            color: isActive ? '#1890ff' : 'rgba(0, 0, 0, 0.45)',
                                            borderRadius: '4px',
                                            transition: 'all 0.3s',
                                            fontWeight: isActive ? '500' : 'normal',
                                            fontSize: '14px',
                                            display: 'flex',
                                            alignItems: 'center',
                                            justifyContent: 'center',
                                            minWidth: '28px',
                                            height: '28px',
                                            userSelect: 'none'
                                        }}
                                        onClick={() => {
                                            if (isActive) {
                                                const scrollContainer = document.querySelector('.status-menu-scroll-container');
                                                const element = document.getElementById(`table-${letter}`);
                                                if (element && scrollContainer) {
                                                    scrollContainer.scrollTo({
                                                        top: element.offsetTop - 120,
                                                        behavior: 'smooth'
                                                    });
                                                }
                                            }
                                        }}
                                    >
                                        {letter}
                                    </Menu.Item>
                                );
                            })}
                        </div>

                        {/* Headers row */}
                        <div style={{ 
                            display: 'grid',
                            gridTemplateColumns: '2fr 1fr 1fr 1fr 1fr',
                            gap: '8px',
                            width: '100%',
                            paddingRight: '12px',
                            borderBottom: '1px solid #e8e8e8',
                            borderTop: '1px solid #e8e8e8',
                            paddingBottom: '8px',  /* Increased padding */
                            paddingTop: '8px'      /* Increased padding */
                        }}>
                            {['TYPE', 'PENDING', 'IN-PROGRESS', 'COMPLETED', 'FAILED'].map((header) => (
                                <Menu.Item 
                                    key={header}
                                    style={{ 
                                        margin: 0,
                                        cursor: 'default',
                                        textAlign: 'left',
                                        padding: '2px 8px',
                                        border: 'none',
                                        backgroundColor: '#ffffff',
                                        color: 'rgba(0, 0, 0, 0.40)',  /* Changed from 0.35 */
                                        borderRadius: '4px',
                                        width: '100%',
                                        minHeight: '24px',
                                        fontWeight: 400,          /* Changed from 500 to 400 */
                                        fontSize: '11px',         /* Changed from 10px */
                                        letterSpacing: '0.5px',
                                        boxSizing: 'border-box',
                                        display: 'flex',
                                        alignItems: 'center'
                                    }}
                                >
                                    {header}
                                </Menu.Item>
                            ))}
                        </div>
                    </div>

                    {/* Scrollable content */}
                    <div 
                        className="status-menu-scroll-container thin-scrollbar"
                        style={{
                            overflowY: 'auto',
                            flex: 1,
                            paddingTop: '4px',
                            padding: '4px 12px 12px 12px',
                            height: '300px',
                            scrollBehavior: 'smooth'
                        }}
                    >
                        {/* Table content */}
                        {[...Array(8)].map((_, tableIndex) => {
                            const title = ['CONNECTIONS', 'CIRCUIT BREAKER', 'ELECTRICAL CONNECTION', 
                                         'ELECTRICAL EQUIPMENT ROOM', 'FIRE EXTINGUISHER', 
                                         'MEASUREMENT & TEST EQUIPMENT CALIBRATION', 'SOLAR PANEL', 'VALVES'][tableIndex];

                            return (
                                <Menu.ItemGroup 
                                    key={tableIndex}
                                    id={`table-${title.charAt(0)}`}
                                >
                                    <div style={{ 
                                        display: 'grid',
                                        gridTemplateColumns: '2fr 1fr 1fr 1fr 1fr',
                                        gap: '8px',
                                        width: '100%',
                                        boxSizing: 'border-box',
                                        minWidth: 0,
                                        scrollMarginTop: '120px'
                                    }}>
                                        {[
                                            title, 'Circuit Breaker', 'Tagged', 'QaPass', 'Decommissioned',
                                            '', 'Tightened', '', 'Deferred', '',
                                            '', '', '', 'Invalid', '',
                                            'hr', 'hr', 'hr', 'hr', 'hr',
                                        ].map((tag, index) => (
                                            tag === 'hr' ? (
                                                <div 
                                                    key={`${tableIndex}-${index}`}
                                                    style={{
                                                        height: '1px',
                                                        backgroundColor: '#e8e8e8',
                                                        margin: '8px 0'
                                                    }}
                                                />
                                            ) : (
                                                <Menu.Item 
                                                    key={`${tableIndex}-${index}`}
                                                    className="menu-list-item"
                                                    style={{
                                                        margin: 0,
                                                        cursor: 'default',
                                                        textAlign: 'left',
                                                        padding: '4px 8px',
                                                        border: 'none',
                                                        backgroundColor: index === 0 ? '#ffffff' : (tag ? '#f5f5f5' : '#ffffff'),
                                                        color: 'rgba(0, 0, 0, 0.85)',
                                                        borderRadius: '4px',
                                                        width: '100%',
                                                        minHeight: '24px',
                                                        whiteSpace: 'nowrap',
                                                        overflow: 'hidden',
                                                        textOverflow: 'ellipsis',
                                                        fontWeight: index === 0 ? '500' : 'normal',
                                                        transition: 'all 0.2s ease',
                                                        position: 'relative'  // Add this to ensure borders work properly
                                                    }}
                                                >
                                                    {tag}
                                                </Menu.Item>
                                            )
                                        ))}
                                    </div>
                                </Menu.ItemGroup>
                            );
                        })}
                    </div>
                </Menu>
            );

            const globalStatusMenu = (
                <Menu style={{ 
                    padding: '12px',
                    width: '600px'
                }}>
                    <div style={{ 
                        display: 'grid',
                        gridTemplateColumns: 'repeat(6, 1fr)',
                        gap: '8px',
                        width: '100%'
                    }}>
                        {[
                            'Connections', 'Test Packs', 'Circuit Breaker', 'Ball Valve',
                            'Cable', 'Ceiling Fan', 'Chiller #1', 'Compressor',
                            'Pump', 'Generator', 'Transformer', 'Switchgear',
                            'Panel', 'Lighting', 'HVAC', 'Fire Alarm',
                        ].map(tag => (
                            <Tag 
                                key={tag}
                                style={{ 
                                    margin: 0,
                                    cursor: 'default',
                                    textAlign: 'center',
                                    padding: '4px 8px',
                                    border: 'none',
                                    backgroundColor: '#f5f5f5',
                                    color: 'rgba(0, 0, 0, 0.85)',
                                    borderRadius: '4px',
                                    width: '100%'
                                }}
                            >
                                {tag}
                            </Tag>
                        ))}
                    </div>
                </Menu>
            );

            const ticketsMenu = (
                <Menu>
                    <Menu.Item>
                        Exceptions <Badge count={3} style={{ marginLeft: 4 }} />
                    </Menu.Item>
                    <Menu.Item>
                        Overtorque <Badge count={0} style={{ marginLeft: 4 }} />
                    </Menu.Item>
                    <Menu.Item>
                        Connection Edits <Badge count={4} style={{ marginLeft: 4 }} />
                    </Menu.Item>
                    <Menu.Item>
                        New Connections <Badge count={6} style={{ marginLeft: 4 }} />
                    </Menu.Item>
                </Menu>
            );

            const handleStatusChange = (status) => {
                safeSetState(() => setCurrentStatusGroup(status));
            };

            return (
                <Layout.Content className="content">
                    <div className="status-groups">
                        <Dropdown overlay={statusMenu} trigger={['hover']}>
                            <Button type="default" className="dropdown-button">
                                <span style={{ fontWeight: 'normal' }}>Status</span>&nbsp;
                                <span style={{ fontWeight: 600 }}>Groups</span> <DownOutlined />
                            </Button>
                        </Dropdown>

                        <Dropdown overlay={globalStatusMenu} trigger={['hover']}>
                            <Button type="default" className="dropdown-button">
                                <span style={{ fontWeight: 'normal' }}>Status</span>&nbsp;
                                <span style={{ fontWeight: 600 }}>Dials</span> <DownOutlined />
                            </Button>
                        </Dropdown>

                        <Dropdown overlay={ticketsMenu} trigger={['hover']}>
                            <Button type="default" className="dropdown-button">
                                <div style={{ 
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '4px'
                                }}>
                                    <span style={{ fontWeight: 600 }}>Tickets</span>
                                    <Badge 
                                        count={13} 
                                        size="small" 
                                        style={{ 
                                            marginTop: '0px'  // Changed from 1px to 0px
                                        }} 
                                    />
                                </div>
                            </Button>
                        </Dropdown>
                    </div>

                    <Row gutter={[16, 16]} className="status-dials">
                        {statusData.map(status => (
                            <Col span={6} key={status.title}>
                                <Card className="status-card">
                                    <Progress
                                        type="circle"
                                        percent={100}
                                        format={() => <span style={{ color: 'black' }}>{status.count}</span>}
                                        strokeColor={status.color}
                                        strokeWidth={12}
                                        width={120}
                                    />
                                    <div className="status-title">{status.title}</div>
                                </Card>
                            </Col>
                        ))}
                    </Row>

                    <Row gutter={[16, 16]} className="s-curves">
                        <Col span={12}>
                            <Card title="Connections S Curve">
                                <div className="chart-placeholder">Chart Placeholder</div>
                            </Card>
                        </Col>
                        <Col span={12}>
                            <Card title="Test Packs S Curve">
                                <div className="chart-placeholder">Chart Placeholder</div>
                            </Card>
                        </Col>
                    </Row>
                </Layout.Content>
            );
        };

        const ControlCenter = () => {
            // Keep all existing state declarations
            const [currentView, setCurrentView] = React.useState('control-center');
            const [controlCenterEditMode, setControlCenterEditMode] = React.useState('View');
            const [workflowBuilderEditMode, setWorkflowBuilderEditMode] = React.useState('View');
            const [showAZOverlay, setShowAZOverlay] = React.useState(false);
            const [searchTerm, setSearchTerm] = React.useState('');
            const [isInteractingWithOverlay, setIsInteractingWithOverlay] = React.useState(false);
            const [title, setTitle] = React.useState('Emergency Exit Door');
            const [isEditingTitle, setIsEditingTitle] = React.useState(false);
            const [tempTitle, setTempTitle] = React.useState('');
            
            // Move tag-related state to parent component
            const [selectedTags, setSelectedTags] = React.useState([]);
            const [showTagSelector, setShowTagSelector] = React.useState(false);

            // Add tag handlers at parent level
            const handleTagRemove = (tagToRemove) => {
                setSelectedTags(prev => prev.filter(tag => tag !== tagToRemove));
                setShowAZOverlay(true);
                setIsInteractingWithOverlay(true);
            };

            const handleTagSelect = (tag) => {
                if (selectedTags.includes(tag)) {
                    setSelectedTags(prev => prev.filter(t => t !== tag));
                } else {
                    setSelectedTags(prev => [...prev, tag]);
                }
                setShowAZOverlay(true);
                setIsInteractingWithOverlay(true);
            };

            // First, add this state near other state declarations in ControlCenter component
            const [wfbView, setWfbView] = React.useState('list');

            // First, add state to control which version is shown
            const [wfbVersion, setWfbVersion] = React.useState('original');

            // Add this near other state declarations in ControlCenter component
            const [wfbFlowView, setWfbFlowView] = React.useState(false);

            // Then update the renderView function to pass the correct variant
            const renderView = () => {
                switch(currentView) {
                    case 'workflow-builder':
                        if (wfbFlowView) {
                            return (
                                <WFBFlow 
                                    editMode={workflowBuilderEditMode}
                                    showAZOverlay={showAZOverlay}
                                    setShowAZOverlay={setShowAZOverlay}
                                    searchTerm={searchTerm}
                                    setSearchTerm={setSearchTerm}
                                    isInteractingWithOverlay={isInteractingWithOverlay}
                                    setIsInteractingWithOverlay={setIsInteractingWithOverlay}
                                    selectedTags={selectedTags}
                                    setSelectedTags={setSelectedTags}
                                />
                            );
                        }
                        return (
                            <WFBOption1 
                                editMode={workflowBuilderEditMode}
                                showAZOverlay={showAZOverlay}
                                setShowAZOverlay={setShowAZOverlay}
                                searchTerm={searchTerm}
                                setSearchTerm={setSearchTerm}
                                isInteractingWithOverlay={isInteractingWithOverlay}
                                setIsInteractingWithOverlay={setIsInteractingWithOverlay}
                                selectedTags={selectedTags}
                                setSelectedTags={setSelectedTags}
                                viewType={wfbView}
                                variant={wfbVersion}
                            />
                        );
                    default:
                        return <MainContent />;
                }
            };

            // Keep existing header functions
            const getHeaderTitle = () => {
                switch(currentView) {
                    case 'workflow-builder':
                        return 'Workflow Builder';
                    default:
                        return 'Control Center';
                }
            };

            const getEditControls = () => {
                if (currentView === 'control-center') {
                    return (
                        <Segmented 
                            options={['View', 'Edit']} 
                            value={controlCenterEditMode}
                            onChange={(value) => {
                                setControlCenterEditMode(value);
                                setShowAZOverlay(false);
                            }}
                            size="middle"
                            style={{ cursor: 'pointer' }}
                        />
                    );
                } else if (currentView === 'workflow-builder') {
                    // Only show edit controls when A-Z overlay is not visible
                    return !showAZOverlay && (
                        <Segmented 
                            options={['View', 'Edit']} 
                            value={workflowBuilderEditMode}
                            onChange={(value) => {
                                setWorkflowBuilderEditMode(value);
                                setShowAZOverlay(false);
                            }}
                            size="middle"
                            style={{ cursor: 'pointer' }}
                        />
                    );
                }
                return null;
            };

            return (
                <Layout className="layout">
                    <Layout.Sider className="sider">
                        <a 
                            onClick={() => setCurrentView('control-center')} 
                            className="sider-link"
                            style={{
                                cursor: 'pointer',
                                color: currentView === 'control-center' ? '#1890ff' : '#fff'
                            }}
                        >
                            Control Center
                        </a>
                        <div className="sider-break"></div>
                        <a 
                            onClick={() => {
                                setCurrentView('workflow-builder');
                                setShowAZOverlay(true);
                                setSearchTerm('');  // Clear any existing search term
                                // Add a small delay to ensure the search input is rendered and expanded
                                setTimeout(() => {
                                    const searchInput = document.querySelector('.search-input');
                                    if (searchInput) {
                                        searchInput.classList.add('expanded');
                                        searchInput.focus();  // Auto-focus the search input
                                    }
                                }, 100);
                            }} 
                            className="sider-link"
                            style={{
                                cursor: 'pointer',
                                color: currentView === 'workflow-builder' ? '#1890ff' : '#fff'
                            }}
                        >
                            Workflow Builder
                        </a>
                    </Layout.Sider>
                    <Layout>
                        <Layout.Header className="header">
                            <div className="header-title" style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                                {getHeaderTitle()}
                                {currentView === 'workflow-builder' && (
                                    <div style={{ 
                                        display: 'flex', 
                                        alignItems: 'center', 
                                        gap: '12px',
                                        flex: 1
                                    }}>
                                        <div className="search-wrapper">
                                            <SearchOutlined 
                                                className="search-icon"
                                                style={{ 
                                                    fontSize: '18px',
                                                    color: 'rgba(0, 0, 0,0.45)',
                                                    cursor: 'pointer',
                                                    transition: 'color 0.3s'
                                                }}
                                                onClick={(e) => {
                                                    e.stopPropagation();  // Prevent event bubbling
                                                    const input = document.querySelector('.search-input');
                                                    input.classList.add('expanded');
                                                    input.focus();
                                                    setShowAZOverlay(true);
                                                }}
                                            />
                                            <Input
                                                className="search-input"
                                                placeholder="Search workflows"
                                                bordered={false}
                                                value={searchTerm}
                                                onChange={(e) => setSearchTerm(e.target.value)}
                                                style={{
                                                    borderBottom: '1px solid #d9d9d9'
                                                }}
                                                onClick={(e) => {
                                                    e.stopPropagation();
                                                }}
                                                onFocus={() => {
                                                    const input = document.querySelector('.search-input');
                                                    input.classList.add('expanded');
                                                    setShowAZOverlay(true);
                                                }}
                                                onBlur={(e) => {
                                                    setTimeout(() => {
                                                        const searchIcon = document.querySelector('.search-icon');
                                                        const isClickingSearchIcon = document.activeElement === searchIcon;
                                                        
                                                        if (!e.target.value && !isInteractingWithOverlay && !isClickingSearchIcon) {
                                                            e.target.classList.remove('expanded');
                                                            // Update version first
                                                            setWfbVersion(wfbView === 'default' ? 'original' : 'variant');
                                                            // Then hide overlay with minimal delay
                                                            setTimeout(() => {
                                                                setShowAZOverlay(false);
                                                            }, 1); // Reduced to 1ms for minimal flash
                                                        }
                                                    }, 100);
                                                }}
                                            />
                                        </div>
                                        
                                        {/* Only show tags section when search overlay is open */}
                                        {showAZOverlay && (
                                            <div 
                                                className="tags-area"
                                                style={{ 
                                                    display: 'flex', 
                                                    gap: '8px', 
                                                    flexWrap: 'wrap',
                                                    alignItems: 'center'
                                                }}
                                            >
                                                {selectedTags.map(tag => (
                                                    <Tag
                                                        key={tag}
                                                        closable
                                                        style={{ 
                                                            margin: 0,
                                                            backgroundColor: '#e6f7ff',
                                                            border: 'none',
                                                            borderRadius: '2px',
                                                            color: '#1890ff',
                                                            fontSize: '12px',
                                                            lineHeight: '20px',
                                                            padding: '0 7px',
                                                            height: '24px',
                                                            display: 'inline-flex',
                                                            alignItems: 'center',
                                                            fontWeight: 400  /* Added this line to ensure normal font weight */
                                                        }}
                                                        onClose={(e) => {
                                                            e.preventDefault();
                                                            e.stopPropagation();
                                                            handleTagRemove(tag);
                                                            const searchInput = document.querySelector('.search-input');
                                                            if (searchInput) {
                                                                searchInput.classList.add('expanded');
                                                            }
                                                        }}
                                                    >
                                                        {tag}
                                                    </Tag>
                                                ))}
                                                <Tooltip title="Add tags" placement="right">
                                                    <Popover
                                                        content={
                                                            <div style={{ display: 'flex', flexDirection: 'column' }}>
                                                                {/* Main content */}
                                                                <div style={{ 
                                                                    width: '400px',
                                                                    maxHeight: '500px',
                                                                    overflow: 'auto',
                                                                    padding: '8px'
                                                                }}
                                                                className="thin-scrollbar"
                                                                >
                                                                    {Object.entries(tagCategories).map(([category, tags]) => (
                                                                        <div key={category} style={{ marginBottom: '16px' }}>
                                                                            <div style={{ 
                                                                                fontWeight: 400, 
                                                                                marginBottom: '8px',
                                                                                color: 'rgba(0, 0, 0, 0.85)',
                                                                                fontSize: '14px',
                                                                                textTransform: 'uppercase'
                                                                            }}>
                                                                                {category}
                                                                            </div>
                                                                            <div style={{ 
                                                                                display: 'flex', 
                                                                                flexWrap: 'wrap', 
                                                                                gap: '8px'
                                                                            }}>
                                                                                {tags.map(tag => (
                                                                                    <Tag
                                                                                        key={tag}
                                                                                        style={{ 
                                                                                            margin: 0,
                                                                                            backgroundColor: selectedTags.includes(tag) ? '#e6f7ff' : '#f5f5f5',
                                                                                            border: 'none',
                                                                                            borderRadius: '2px',
                                                                                            color: selectedTags.includes(tag) ? '#1890ff' : 'rgba(0, 0, 0, 0.85)',
                                                                                            fontSize: '12px',
                                                                                            lineHeight: '20px',
                                                                                            padding: '0 7px',
                                                                                            cursor: 'pointer',
                                                                                            transition: 'all 0.3s',
                                                                                            height: '24px',
                                                                                            display: 'inline-flex',
                                                                                            alignItems: 'center',
                                                                                            fontWeight: 400  /* Added this line to ensure normal font weight */
                                                                                        }}
                                                                                        onClick={(e) => {
                                                                                            e.stopPropagation();
                                                                                            handleTagSelect(tag);
                                                                                        }}
                                                                                    >
                                                                                        {tag}
                                                                                    </Tag>
                                                                                ))}
                                                                            </div>
                                                                        </div>
                                                                    ))}
                                                                </div>

                                                                {/* Footer with buttons */}
                                                                <div style={{ 
                                                                    borderTop: '1px solid #f0f0f0',
                                                                    padding: '8px',
                                                                    display: 'flex',
                                                                    justifyContent: 'space-between', // Changed from flex-end to space-between
                                                                    gap: '8px'
                                                                }}>
                                                                    <Button 
                                                                        type="text" 
                                                                        size="small"
                                                                        onClick={(e) => {
                                                                            e.stopPropagation();
                                                                            setSelectedTags([]);
                                                                        }}
                                                                        style={{
                                                                            fontSize: '12px',
                                                                            color: 'rgba(0, 0, 0, 0.45)',
                                                                            padding: '4px 8px',
                                                                            height: '22px', // Reduced from 24px
                                                                            transition: 'color 0.3s',
                                                                            backgroundColor: 'white' // Added to ensure white background
                                                                        }}
                                                                        onMouseEnter={(e) => {
                                                                            e.currentTarget.style.color = '#1890ff';
                                                                            e.currentTarget.style.backgroundColor = 'white'; // Explicitly set on hover
                                                                        }}
                                                                        onMouseLeave={(e) => {
                                                                            e.currentTarget.style.color = 'rgba(0, 0, 0, 0.45)';
                                                                        }}
                                                                    >
                                                                        Reset
                                                                    </Button>
                                                                    <div style={{ display: 'flex', gap: '8px' }}>
                                                                        <Button 
                                                                            size="small"
                                                                            onClick={(e) => {
                                                                                e.stopPropagation();
                                                                                // Add logic to close popover
                                                                            }}
                                                                            style={{
                                                                                fontSize: '12px',
                                                                                padding: '4px 12px', // Increased horizontal padding by 4px
                                                                                height: '22px', // Reduced from 24px
                                                                                borderRadius: '4px',
                                                                                display: 'flex',
                                                                                alignItems: 'center',
                                                                                lineHeight: '14px'  // Added for text centering
                                                                            }}
                                                                        >
                                                                            Cancel
                                                                        </Button>
                                                                        <Button 
                                                                            type="primary"
                                                                            size="small"
                                                                            onClick={(e) => {
                                                                                e.stopPropagation();
                                                                                // Add logic to save tags and close popover
                                                                            }}
                                                                            style={{
                                                                                fontSize: '12px',
                                                                                padding: '4px 12px', // Increased horizontal padding by 4px
                                                                                height: '22px', // Reduced from 24px
                                                                                borderRadius: '4px',
                                                                                display: 'flex',
                                                                                alignItems: 'center',
                                                                                lineHeight: '14px'  // Added for text centering
                                                                            }}
                                                                        >
                                                                            Save
                                                                        </Button>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        }
                                                        // ... rest of your popover props
                                                    >
                                                        <Tag
                                                            className="tag-button"
                                                            style={{ 
                                                                margin: 0,
                                                                backgroundColor: '#f5f5f5',
                                                                border: 'none',
                                                                borderRadius: '2px',
                                                                color: 'rgba(0, 0, 0, 0.5)',
                                                                fontSize: '12px',
                                                                lineHeight: '20px',
                                                                padding: '0 7px',
                                                                cursor: 'pointer',
                                                                height: '24px',
                                                                display: 'inline-flex',
                                                                alignItems: 'center',
                                                                fontWeight: 500,
                                                                transition: 'all 0.3s'
                                                            }}
                                                            onMouseEnter={(e) => {
                                                                e.currentTarget.style.backgroundColor = '#e6f7ff';
                                                                e.currentTarget.style.color = '#1890ff';
                                                            }}
                                                            onMouseLeave={(e) => {
                                                                e.currentTarget.style.backgroundColor = '#f5f5f5';
                                                                e.currentTarget.style.color = 'rgba(0, 0, 0, 0.5)';
                                                            }}
                                                            onClick={(e) => {
                                                                e.stopPropagation();
                                                                e.preventDefault();
                                                                setShowAZOverlay(true);  // Add this line
                                                                setIsInteractingWithOverlay(true);
                                                            }}
                                                        >
                                                            Tags
                                                        </Tag>
                                                    </Popover>
                                                </Tooltip>
                                            </div>
                                        )}
                                    </div>
                                )}
                            </div>
                            <div className="header-right">
                                {/* Only show edit controls when A-Z overlay is not visible */}
                                <div style={{ 
                                    opacity: showAZOverlay ? 0 : 1,
                                    transition: 'opacity 0.3s',
                                    pointerEvents: showAZOverlay ? 'none' : 'auto'
                                }}>
                                    {getEditControls()}
                                </div>
                            </div>
                        </Layout.Header>
                        {/* Update the view icons section to only show in workflow-builder view */}
                        {currentView === 'workflow-builder' && (
                            <div style={{
                                position: 'fixed',
                                right: '24px',
                                top: '148px',  // Changed from 112px to 148px to align with Main Workflow dropdown
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                zIndex: 1,
                                opacity: showAZOverlay ? 0 : 1,
                                transition: 'opacity 0.3s',
                                pointerEvents: showAZOverlay ? 'none' : 'auto',
                                width: '32px',
                                height: '32px'
                            }}>
                                <div style={{
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    width: '100%',
                                    height: '100%'
                                }}>
                                    {wfbView === 'default' ? (
                                        <Tooltip title="Switch View" placement="left">
                                            <UnorderedListOutlined 
                                                style={{ 
                                                    fontSize: '18px',
                                                    color: 'rgba(0, 0, 0, 0.45)',
                                                    cursor: 'pointer',
                                                    transition: 'color 0.3s'
                                                }}
                                                className="view-icon"
                                                onClick={() => {
                                                    setWfbView('tile');
                                                    setWfbVersion('variant');
                                                    setWfbFlowView(false);  // Add this line to turn off flow view
                                                }}
                                            />
                                        </Tooltip>
                                    ) : (
                                        <Tooltip title="Switch View" placement="left">
                                            <AppstoreOutlined 
                                                style={{ 
                                                    fontSize: '18px',
                                                    color: 'rgba(0, 0, 0, 0.45)',
                                                    cursor: 'pointer',
                                                    transition: 'color 0.3s'
                                                }}
                                                className="view-icon"
                                                onClick={() => {
                                                    setWfbView('default');
                                                    setWfbVersion('original');
                                                    setWfbFlowView(false);  // Add this line to turn off flow view
                                                }}
                                            />
                                        </Tooltip>
                                    )}
                                </div>
                            </div>
                        )}
                        {currentView === 'workflow-builder' && (
                            <div style={{
                                position: 'fixed',
                                right: '24px',
                                top: '148px',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                zIndex: 1,
                                opacity: showAZOverlay ? 0 : 1,
                                transition: 'opacity 0.3s',
                                pointerEvents: showAZOverlay ? 'none' : 'auto',
                                gap: '16px'  // Add gap between icons
                            }}>
                                {/* Add Node Index Icon */}
                                <div style={{
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    width: '32px',
                                    height: '32px'
                                }}>
                                    <Tooltip title="Node View" placement="left">
                                        <NodeIndexOutlined 
                                            style={{ 
                                                fontSize: '18px',
                                                color: wfbFlowView ? '#1890ff' : 'rgba(0, 0, 0, 0.45)',
                                                cursor: wfbFlowView ? 'default' : 'pointer',  // Add this line
                                                transition: 'color 0.3s',
                                                opacity: wfbFlowView ? 0.65 : 1  // Add this line
                                            }}
                                            className="view-icon"
                                            onClick={() => {
                                                if (!wfbFlowView) {  // Add this condition
                                                    setWfbFlowView(true);
                                                    setWfbView('default');
                                                    setWfbVersion('original');
                                                }
                                            }}
                                        />
                                    </Tooltip>
                                </div>

                                {/* Existing View Toggle Icon */}
                                <div style={{
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    width: '32px',
                                    height: '32px'
                                }}>
                                    {wfbView === 'default' ? (
                                        <Tooltip title="Switch to Tile View" placement="left">
                                            <UnorderedListOutlined 
                                                style={{ 
                                                    fontSize: '18px',
                                                    color: 'rgba(0, 0, 0, 0.45)',
                                                    cursor: 'pointer',
                                                    transition: 'color 0.3s'
                                                }}
                                                className="view-icon"
                                                onClick={() => {
                                                    setWfbView('tile');
                                                    setWfbVersion('variant');
                                                    setWfbFlowView(false);  // Add this line to turn off flow view
                                                }}
                                            />
                                        </Tooltip>
                                    ) : (
                                        <Tooltip title="Switch to List View" placement="left">
                                            <AppstoreOutlined 
                                                style={{ 
                                                    fontSize: '18px',
                                                    color: 'rgba(0, 0, 0, 0.45)',
                                                    cursor: 'pointer',
                                                    transition: 'color 0.3s'
                                                }}
                                                className="view-icon"
                                                onClick={() => {
                                                    setWfbView('default');
                                                    setWfbVersion('original');
                                                    setWfbFlowView(false);  // Add this line to turn off flow view
                                                }}
                                            />
                                        </Tooltip>
                                    )}
                                </div>
                            </div>
                        )}
                        {renderView()}
                    </Layout>
                </Layout>
            );
        };

        ReactDOM.render(<ControlCenter />, document.getElementById('app'));
    </script>
</body>
</html>
